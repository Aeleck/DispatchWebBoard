fr.client={clipboard:null,CachedRescues:{},SelectedRescue:null,initComp:!1,socket:null,sysApi:null,theme:"default",init:function(){this.initComp?window.console.debug("fr.client.init - init completed already!"):(window.console.debug("fr.client.init - Client manager loaded."),$("#navbar-brand-title").text(fr.config.WebPageTitle),window.onpopstate=this.HandlePopState,window.onbeforeunload=(()=>{window.localStorage.setItem(`${fr.config.AppNamespace}.window.theme`,$("body").attr("style"))}),window.localStorage.getItem(`${fr.config.AppNamespace}.window.theme`)?this.theme=window.localStorage.getItem(`${fr.config.AppNamespace}.window.theme`):window.localStorage.setItem(`${fr.config.AppNamespace}.window.theme`,"default"),"default"!==this.theme&&$("body").attr("style",this.theme),$("body").on("click","button.btn.btn-detail",e=>{this.SetSelectedRescue(e.currentTarget.dataset.rescueSid)}).on("click","button.btn.btn-nav-toggle",e=>{$(e.currentTarget.dataset.target).toggleClass("expand");$(e.currentTarget).toggleClass("active")}).on("click","a.panel-settings-toggle",e=>{window.alert("This doesn't do anything yet. lol!");e.preventDefault()}),Clipboard.isSupported()&&(this.clipboard=new Clipboard(".btn-clipboard"),$("body").addClass("clipboard-enable")),this.sysApi=new StarSystems,this.socket=new RatSocket(fr.config.WssURI),this.socket.on("ratsocket:reconnect",e=>{this.handleReconnect(e)}).on("rescue:created",(e,t)=>{this.AddRescue(e,t.data||null)}).on("rescue:updated",(e,t)=>{this.UpdateRescue(e,t.data||null)}).start().then(()=>this.socket.authenticate(fr.user.AuthHeader)).then(()=>this.socket.subscribe("0xDEADBEEF")).then(()=>this.socket.request({action:"rescues:read",data:{open:"true"}})).then(e=>{this.PopulateBoard(e.context,e.data)}).catch(e=>{window.console.error(e)}),this.UpdateClocks(),this.initComp=!0)},handleReconnect:function(e){e.request({action:"rescues:read",data:{open:"true"},meta:{updateList:"true"}})},PopulateBoard:function(e,t){let a=t.data;for(let t in a)a.hasOwnProperty(t)&&this.AddRescue(e,a[t]);this.ParseQueryString(),$("body").removeClass("loading")},FetchRatInfo:function(e){if(sessionStorage.getItem(`${fr.config.AppNamespace}.rat.${e}`)){let t=JSON.parse(sessionStorage.getItem(`${fr.config.AppNamespace}.rat.${e}`));return window.console.debug("fr.client.FetchRatInfo - Cached Rat Requested: ",t),Promise.resolve(t)}return window.console.debug(`fr.client.FetchRatInfo - Gathering RatInfo: ${e}`),this.socket.request({action:"rats:read",data:{id:e},meta:{searchId:e}}).then(t=>{sessionStorage.setItem(`${fr.config.AppNamespace}.rat.${e}`,JSON.stringify(t.data));return Promise.resolve(t.data)})},ParseQueryString:function(){let e=$.getUrlParam("a");e&&this.CachedRescues[e]?this.SetSelectedRescue(e,!0):history.replaceState&&window.history.replaceState({a:null},document.title,window.location.pathname)},HandlePopState:function(e){this.SetSelectedRescue(e.state.a,!0)},AddRescue:function(e,t){if(!t)return;let a=t,s=a.id.split("-")[0];null===a.data&&(a.data={}),null===a.system&&(a.system=""),$(`tr.rescue[data-rescue-sid="${s}"]`).length>0?this.UpdateRescue(a):(window.console.debug("fr.client.AddRescue: Rescue Added to board."),this.CachedRescues[s]=a,this.appendHtml("#rescueTable",this.GetRescueTableRow(a)),this.sysApi.get(a.system).then(()=>{window.console.debug("fr.client.AddRescue - Additional info found! Caching...")}).catch(()=>{window.console.debug("fr.client.AddRescue - No additional system information found.")}))},UpdateRescue:function(e,t){if(!t)return;let a=t,s=a.id.split("-")[0],n=$(`tr.rescue[data-rescue-sid="${s}"]`);if(n){if(!a.open)return setTimeout(function(){n.hide("slow").remove()},5e3),window.console.debug(`fr.client.UpdateRescue - Rescue Removed: ${a.id} : ${a.client}`),a.id&&this.SelectedRescue&&a.id===this.SelectedRescue.id&&this.SetSelectedRescue(null),void delete this.CachedRescues[s];window.console.debug(`fr.client.UpdateRescue - Rescue Updated: ${a.id} : ${a.client}`),this.replaceHtml(`tr.rescue[data-rescue-sid="${s}"]`,this.GetRescueTableRow(a)),this.CachedRescues[s]=a,a.id&&this.SelectedRescue&&a.id===this.SelectedRescue.id&&(window.console.debug(`fr.client.UpdateRescue - Rescue DetailView Updating: ${a.id} : ${a.client}`),this.SelectedRescue=a,this.UpdateRescueDetail())}else window.console.debug("fr.client.UpdateRescue: Attempted to update a non-existant rescue: ",a)},GetRescueTableRow:function(e){if(!e)return;let t=e=>{let t=$(`.rescue-row-rats > .rat[data-rat-uuid="${e.meta.searchId}"]`);if(e.data.length>0){let a=e.data[0];t.text(a.CMDRname)}else t.html("<i>Rat not found!</i>").attr("title",e.meta.searchId)},a=e=>{window.console.error("fr.client.UpdateRescueDetail - Rat info error: ",e);"object"==typeof e&&"object"==typeof e.meta&&"string"==typeof e.meta.searchId&&$(`.rescue-row-rats > .rat[data-rat-uuid="${e.meta.searchId}"]`).html("<i>Connection Error</i>").attr("title",e.meta.searchId)},s=e.id.split("-")[0],n=e.rats,i=[];for(let s in n)n.hasOwnProperty(s)&&(this.FetchRatInfo(n[s]).then(t).catch(a),i.push(`<span class="rat" data-rat-uuid="${e.rats[s]}"><i>Loading</i></span>`));for(let t in e.unidentifiedRats)e.unidentifiedRats.hasOwnProperty(t)&&i.push(`<span class="rat-unidentified"><i>${e.unidentifiedRats[t]}</i></span>`);let o=e.data.langID?fr.const.language[e.data.langID]?fr.const.language[e.data.langID]:{short:e.data.langID,long:e.data.langID}:fr.const.language.unknown,d=e.platform?fr.const.platform[e.platform]:fr.const.platform.unknown,c=$(`<tr class="rescue" data-rescue-sid="${s}">`+`<td class="rescue-row-index">${"number"==typeof e.data.boardIndex?e.data.boardIndex:"?"}</td>`+`<td class="rescue-row-client" title="${e.data.IRCNick||""}">${e.client||"?"}</td>`+`<td class="rescue-row-language" title="${o.long}">${o.short}</td>`+`<td class="rescue-row-platform" title="${d.long}">${d.short}</td>`+`<td class="rescue-row-system btn-clipboard" data-clipboard-text="${e.system}">${e.system} <i class="fa fa-clipboard" title="Click to Copy!"></i></td>`+`<td class="rescue-row-rats">${i.join(", ")}</td>`+`<td class="rescue-row-detail"><button type="button" class="btn btn-detail" data-rescue-sid="${s}"><span class="fa fa-info" aria-hidden="true"></span></button></td>`+"</tr>");e.epic?c.addClass("rescue-epic"):c.removeClass("rescue-epic"),e.codeRed?c.addClass("rescue-codered"):c.removeClass("rescue-codered"),e.active?c.removeClass("rescue-inactive"):c.addClass("rescue-inactive");let l=e.quotes.join("\n");return c.attr("title",l),c},UpdateClocks:function(){let e=new Date;$(".ed-clock").text(e.getUTCFullYear()+1286+" "+fr.const.monthString[e.getUTCMonth()]+" "+(e.getUTCDate()<10?"0":"")+e.getUTCDate()+" "+(e.getUTCHours()<10?"0":"")+e.getUTCHours()+":"+(e.getUTCMinutes()<10?"0":"")+e.getUTCMinutes()+":"+(e.getUTCSeconds()<10?"0":"")+e.getUTCSeconds()),null!==this.SelectedRescue&&$(".rdetail-timer").text(Util.getTimeSpanString(e,Date.parse(this.SelectedRescue.createdAt))).prop("title","Last Updated: "+Util.getTimeSpanString(e,Date.parse(this.SelectedRescue.updatedAt))),setTimeout(()=>{this.UpdateClocks()},1e3-e.getMilliseconds())},SetSelectedRescue:function(e,t){if(null===e||this.SelectedRescue&&e.toString()===this.SelectedRescue.id.split("-")[0])return this.SelectedRescue=null,history.pushState&&!t&&window.history.pushState({a:null},document.title,window.location.pathname),void this.UpdateRescueDetail();this.CachedRescues[e]?(window.console.debug(`fr.client.SetSelectedRescue - New SelectedRescue: ${this.CachedRescues[e].id}`),this.SelectedRescue=this.CachedRescues[e],history.pushState&&!t&&window.history.pushState({a:e},document.title,window.location.pathname+`?a=${encodeURIComponent(e)}`),this.UpdateRescueDetail()):window.console.error(`fr.client.SetSelectedRescue - invalid key: ${e}`)},UpdateRescueDetail:function(){if($("button.btn-detail.active").removeClass("active"),!this.SelectedRescue)return void $("body").removeClass("rdetail-active");let e=this.SelectedRescue,t="number"==typeof e.data.boardIndex?`#${e.data.boardIndex} - `:"",a=e.title?e.title:e.client,s=(e.codeRed?' <span class="badge badge-red">Code Red</span>':"")+(e.active?"":' <span class="badge badge-yellow">Inactive</span>'),n=e.data.langID?fr.const.language[e.data.langID]?fr.const.language[e.data.langID]:{short:e.data.langID,long:e.data.langID}:fr.const.language.unknown,i=e.platform?fr.const.platform[e.platform]:fr.const.platform.unknown,o=`<div class="rdetail-header"><div class="rdetail-title">${t+a+s}</div><div class="rdetail-timer">00:00:00</div></div>`+'<table class="rdetail-body table table-rescue"><thead><td width="90px"></td><td></td></thead><tbody>'+(e.data.IRCNick?'<tr class="rdetail-info"><td class="rdetail-info-title">IRC Nick</td>'+`<td class="rdetail-info-value">${e.data.IRCNick}</td></tr>`:"")+(e.system?'<tr class="rdetail-info"><td class="rdetail-info-title">System</td>'+`<td class="rdetail-info-value">${e.system}`+`<span class="float-right system-apidata" data-system-name="${e.system.toUpperCase()}"><i>Retrieving info...</i></span></td></tr>`:"")+(e.platform?'<tr class="rdetail-info"><td class="rdetail-info-title">Platform</td>'+`<td class="rdetail-info-value">${i.long}</td></tr>`:"")+(e.data.langID?'<tr class="rdetail-info"><td class="rdetail-info-title">Language</td>'+`<td class="rdetail-info-value">${n.long} (${n.short})</td></tr>`:"")+'<tr class="rdetail-info"><td class="rdetail-info-title">UUID</td>'+`<td class="rdetail-info-value">${e.id}</td></tr>`+'<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>',d=t=>{let a=$(`.rdetail-info > .rdetail-info-value > .rat[data-rat-uuid="${t.meta.searchId}"]`);if(t.data.length>0){let s=t.data[0];a.html(s.CMDRname+(e.platform===s.platform?"":` <span class="badge badge-yellow">BAD PLATFORM: RAT IS ${s.platform.toUpperCase()}</span>`))}else a.html("<i>Rat not found!</i>")},c=e=>{window.console.error("fr.client.UpdateRescueDetail - Rat info error: ",e);"object"==typeof e&&"object"==typeof e.meta&&"string"==typeof e.meta.searchId&&$(`.rdetail-info > .rdetail-info-value > .rat[data-rat-uuid="${e.meta.searchId}"]`).html("<i>Connection Error</i>")},l=[];for(let t in e.rats)e.rats.hasOwnProperty(t)&&(this.FetchRatInfo(e.rats[t]).then(d).catch(c),l.push(`<span class="rat" data-rat-uuid="${e.rats[t]}"><i>Loading</i></span>`));for(let t in e.unidentifiedRats)e.unidentifiedRats.hasOwnProperty(t)&&l.push(`<span class="rat-unidentified">${e.unidentifiedRats[t]}</span> <span class="badge badge-yellow">unidentified</span>`);if(l.length>0){if(o+='<tr class="rdetail-info"><td class="rdetail-info-title">Rats</td><td class="rdetail-info-value tbl-border-box">'+l[0]+"</td></tr>",l.length>1)for(let e=1;e<l.length;e++)o+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${l[e]}</td></tr>`;o+='<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>'}if(e.quotes.length>0&&(o+=`<tr class="rdetail-info"><td class="rdetail-info-title">Quotes</td><td class="rdetail-info-value tbl-border-box">${e.quotes[0]}</td></tr>`,e.quotes.length>1))for(let t=1;t<e.quotes.length;t++)o+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${e.quotes[t]}</td></tr>`;o+="</tbody></table>",window.console.debug(`fr.client.UpdateRescueDetail - Rescue DetailView Updated: ${e.id} : ${e.client}`),this.setHtml("#rescueDetailContent",o),$(`button.btn.btn-detail[data-rescue-sid="${e.id.split("-")[0]}"]`).addClass("active"),$("body").addClass("rdetail-active"),e.system&&(window.console.debug("fr.client.UpdateRescueDetail - Checking sysapi for additional system info."),this.getSystemHtml(e).then(t=>{this.setHtml(`span[data-system-name="${e.system.toUpperCase()}"]`,t)}).catch(()=>{this.setHtml(`span[data-system-name="${e.system.toUpperCase()}"]`,'<a target="_blank" href="https://www.eddb.io/"><span class="badge badge-red" title="Go to EDDB.io" >NOT IN EDDB</span></a>')}))},getSystemHtml:function(e){return e?this.sysApi.get(e.system).then(e=>{window.console.debug("this.UpdateRescueDetail - Additional info found! Adding system-related warnings and eddb link.");let t=e;t.attributes.name.toUpperCase();let a="";t.attributes.needs_permit&&1===t.attributes.needs_permit&&(a+='<span class="badge badge-yellow" title="This system requires a permit!">PERMIT</span> ');t.attributes.is_populated&&1===t.attributes.is_populated&&(a+=' <span class="badge badge-yellow" title="This system is populated, check for stations!">POPULATED</span> ');if(t.bodies&&t.bodies.length>0){let e=t.bodies.find(function(e){return e.attributes.is_main_star});e&&fr.const.scoopables.includes(e.attributes.spectral_class)?a+=' <span class="badge badge-yellow" title="This system\'s main star is scoopable!">SCOOPABLE</span> ':t.bodies.length>1&&t.bodies.filter(function(e){return fr.const.scoopables.includes(e.attributes.spectral_class)}).length>0&&(a+=' <span class="badge badge-yellow" title="This system contains a scoopable star!">SCOOPABLE [SECONDARY]</span> ')}t.id&&(a+=`<a target="_blank" href="https://www.eddb.io/system/${t.id}"><span class="badge badge-green" title="View on EDDB.io" >EDDB</span></a>`);return Promise.resolve(a)}):Promise.reject("")},setHtml:function(e,t){$(e).animate({opacity:.2},100).html(t).animate({opacity:1},500)},replaceHtml:function(e,t){$(e).replaceWith(t),$(e).animate({opacity:.2},100).animate({opacity:1},500)},appendHtml:function(e,t){$(e).append(t)}};