fr.client={clipboard:null,CachedRescues:{},SelectedRescue:null,initComp:!1,socket:null,sysApi:null,theme:"default",init:function(){this.initComp?window.console.debug("fr.client.init - init completed already!"):(window.console.debug("fr.client.init - Client manager loaded."),$("#navbar-brand-title").text(fr.config.WebPageTitle),window.onpopstate=this.HandlePopState,window.onbeforeunload=(()=>{window.localStorage.setItem(`${fr.config.AppNamespace}.window.theme`,$("body").attr("style"))}),window.localStorage.getItem(`${fr.config.AppNamespace}.window.theme`)?this.theme=window.localStorage.getItem(`${fr.config.AppNamespace}.window.theme`):window.localStorage.setItem(`${fr.config.AppNamespace}.window.theme`,"default"),"default"!==this.theme&&$("body").attr("style",this.theme),$("body").on("click","button.btn.btn-detail",e=>{this.SetSelectedRescue(e.currentTarget.dataset.rescueSid)}).on("click",".class-toggle",e=>{$(e.currentTarget.dataset.target).toggleClass(e.currentTarget.dataset.targetClass)}).on("click","a.panel-settings-toggle",e=>{window.alert("This doesn't do anything yet. lol!");e.preventDefault()}),Clipboard.isSupported()&&(this.clipboard=new Clipboard(".btn-clipboard"),$("body").addClass("clipboard-enable")),this.sysApi=new StarSystems,this.socket=new RatSocket(fr.config.WssURI),this.socket.on("ratsocket:reconnect",e=>this.handleReconnect(e)).on("rescueCreated",(e,t)=>{t.included&&(t=Util.mapRelationships(t));this.AddRescue(e,t.data)}).on("rescueUpdated",(e,t)=>{t.included&&(t=Util.mapRelationships(t));window.console.log("DEBUG 1");for(let s=0;s<t.data.length;s+=1)window.console.log("DEBUG 2"),this.UpdateRescue(e,t.data[s])}).connect(fr.user.AuthHeader).then(()=>this.socket.subscribe("0xDEADBEEF")).then(()=>this.socket.request({action:["rescues","read"],data:{open:!0}})).then(e=>this.PopulateBoard(e.context,e.data)).catch(e=>window.console.error(e)),$("body").removeClass("loading"),this.UpdateClocks(),this.initComp=!0)},handleReconnect:function(e){e.request({action:"rescues:read",data:{open:"true"},meta:{updateList:"true"}})},PopulateBoard:function(e,t){let s=t.data;for(let t in s)s.hasOwnProperty(t)&&this.AddRescue(e,s[t]);this.ParseQueryString(),$("body").removeClass("loading")},FetchRatInfo:function(e){if(sessionStorage.getItem(`${fr.config.AppNamespace}.rat.${e}`)){let t=JSON.parse(sessionStorage.getItem(`${fr.config.AppNamespace}.rat.${e}`));return window.console.debug("fr.client.FetchRatInfo - Cached Rat Requested: ",t),Promise.resolve(t)}return window.console.debug(`fr.client.FetchRatInfo - Gathering RatInfo: ${e}`),this.socket.request({action:"rats:read",data:{id:e},meta:{searchId:e}}).then(t=>{sessionStorage.setItem(`${fr.config.AppNamespace}.rat.${e}`,JSON.stringify(t.data));return Promise.resolve(t.data)})},ParseQueryString:function(){let e=$.getUrlParam("a");e&&this.CachedRescues[e]?this.SetSelectedRescue(e,!0):history.replaceState&&window.history.replaceState({a:null},document.title,window.location.pathname)},HandlePopState:function(e){this.SetSelectedRescue(e.state.a,!0)},AddRescue:function(e,t){if(!t)return;let s=t,a=s.id.split("-")[0];$(`tr.rescue[data-rescue-sid="${a}"]`).length>0?this.UpdateRescue(s):(window.console.debug("fr.client.AddRescue: Rescue Added to board."),this.CachedRescues[a]=s,this.appendHtml("#rescueTable",this.GetRescueTableRow(s)),this.sysApi.get(s.attributes.system).then(()=>{window.console.debug("fr.client.AddRescue - Additional info found! Caching...")}).catch(()=>{window.console.debug("fr.client.AddRescue - No additional system information found.")}))},UpdateRescue:function(e,t){if(!t)return;window.console.log("DEBUG 3 - ",t);let s=t,a=s.id.split("-")[0],i=$(`tr.rescue[data-rescue-sid="${a}"]`);return i.length<1?(window.console.debug("fr.client.UpdateRescue: Attempted to update a non-existent rescue: ",s),void this.AddRescue(e,s)):"closed"===s.attributes.state?(setTimeout(function(){i.hide("slow").remove()},5e3),window.console.debug(`fr.client.UpdateRescue - Rescue Removed: ${s.id} : ${s.client}`),s.id&&this.SelectedRescue&&s.id===this.SelectedRescue.id&&this.SetSelectedRescue(null),void delete this.CachedRescues[a]):(window.console.debug(`fr.client.UpdateRescue - Rescue Updated: ${s.id} : ${s}`),this.replaceHtml(`tr.rescue[data-rescue-sid="${a}"]`,this.GetRescueTableRow(s)),this.CachedRescues[a]=s,void(s.id&&this.SelectedRescue&&s.id===this.SelectedRescue.id&&(window.console.debug(`fr.client.UpdateRescue - Rescue DetailView Updating: ${s.id} : ${s.client}`),this.SelectedRescue=s,this.UpdateRescueDetail())))},GetRescueTableRow:function(e){if(!e)return;let t=e.id.split("-")[0],s=void 0===e.relationships.rats.data?e.relationships.rats:{},a=[];for(let t in s)s.hasOwnProperty(t)&&a.push(`<span class="rat" data-rat-uuid="${t}">${e.relationships.rats[t].attributes.name}</span>`);for(let t in e.attributes.unidentifiedRats)e.unidentifiedRats.hasOwnProperty(t)&&a.push(`<span class="rat-unidentified"><i>${e.attributes.unidentifiedRats[t]}</i></span>`);let i=e.attributes.data.langID?fr.const.language[e.attributes.data.langID]?fr.const.language[e.attributes.data.langID]:{short:e.attributes.data.langID,long:e.attributes.data.langID}:fr.const.language.unknown,n=e.attributes.platform?fr.const.platform[e.attributes.platform]:fr.const.platform.unknown,o=$(`<tr class="rescue" data-rescue-sid="${t}">`+`<td class="rescue-row-index">${"number"==typeof e.attributes.data.boardIndex?e.attributes.data.boardIndex:"?"}</td>`+`<td class="rescue-row-client" title="${e.attributes.data.IRCNick||""}">${e.attributes.client||"?"}</td>`+`<td class="rescue-row-language" title="${i.long}">${i.short}</td>`+`<td class="rescue-row-platform" title="${n.long}">${n.short}</td>`+`<td class="rescue-row-system btn-clipboard" data-clipboard-text="${e.system}">${e.system} <i class="fa fa-clipboard" title="Click to Copy!"></i></td>`+`<td class="rescue-row-rats">${a.join(", ")}</td>`+`<td class="rescue-row-detail"><button type="button" class="btn btn-detail" data-rescue-sid="${t}"><span class="fa fa-info" aria-hidden="true"></span></button></td>`+"</tr>");e.attributes.codeRed?o.addClass("rescue-codered"):o.removeClass("rescue-codered"),"inactive"===e.attributes.status?o.addClass("rescue-inactive"):o.removeClass("rescue-inactive");let d=e.attributes.quotes.join("\n");return o.attr("title",d),o},UpdateClocks:function(){let e=new Date;$(".ed-clock").text(e.getUTCFullYear()+1286+" "+fr.const.monthString[e.getUTCMonth()]+" "+(e.getUTCDate()<10?"0":"")+e.getUTCDate()+" "+(e.getUTCHours()<10?"0":"")+e.getUTCHours()+":"+(e.getUTCMinutes()<10?"0":"")+e.getUTCMinutes()+":"+(e.getUTCSeconds()<10?"0":"")+e.getUTCSeconds()),null!==this.SelectedRescue&&$(".rdetail-timer").text(Util.getTimeSpanString(e,Date.parse(this.SelectedRescue.attributes.createdAt))).prop("title","Last Updated: "+Util.getTimeSpanString(e,Date.parse(this.SelectedRescue.attributes1.updatedAt))),setTimeout(()=>{this.UpdateClocks()},1e3-e.getMilliseconds())},SetSelectedRescue:function(e,t){if(null===e||this.SelectedRescue&&e.toString()===this.SelectedRescue.id.split("-")[0])return this.SelectedRescue=null,history.pushState&&!t&&window.history.pushState({a:null},document.title,window.location.pathname),void this.UpdateRescueDetail();this.CachedRescues[e]?(window.console.debug(`fr.client.SetSelectedRescue - New SelectedRescue: ${this.CachedRescues[e].id}`),this.SelectedRescue=this.CachedRescues[e],history.pushState&&!t&&window.history.pushState({a:e},document.title,window.location.pathname+`?a=${encodeURIComponent(e)}`),this.UpdateRescueDetail()):window.console.error(`fr.client.SetSelectedRescue - invalid key: ${e}`)},UpdateRescueDetail:function(){if($("button.btn-detail.active").removeClass("active"),!this.SelectedRescue)return void $("body").removeClass("rdetail-active");let e=this.SelectedRescue,t="number"==typeof e.data.boardIndex?`#${e.data.boardIndex} - `:"",s=e.title?e.title:e.client,a=(e.codeRed?' <span class="badge badge-red">Code Red</span>':"")+(e.active?"":' <span class="badge badge-yellow">Inactive</span>'),i=e.data.langID?fr.const.language[e.data.langID]?fr.const.language[e.data.langID]:{short:e.data.langID,long:e.data.langID}:fr.const.language.unknown,n=e.platform?fr.const.platform[e.platform]:fr.const.platform.unknown,o=`<div class="rdetail-header"><div class="rdetail-title">${t+s+a}</div><div class="rdetail-timer">00:00:00</div></div>`+'<table class="rdetail-body table table-rescue"><thead><td width="90px"></td><td></td></thead><tbody>'+(e.data.IRCNick?'<tr class="rdetail-info"><td class="rdetail-info-title">IRC Nick</td>'+`<td class="rdetail-info-value">${e.data.IRCNick}</td></tr>`:"")+(e.system?'<tr class="rdetail-info"><td class="rdetail-info-title">System</td>'+`<td class="rdetail-info-value">${e.system}`+`<span class="float-right system-apidata" data-system-name="${e.system.toUpperCase()}"><i>Retrieving info...</i></span></td></tr>`:"")+(e.platform?'<tr class="rdetail-info"><td class="rdetail-info-title">Platform</td>'+`<td class="rdetail-info-value">${n.long}</td></tr>`:"")+(e.data.langID?'<tr class="rdetail-info"><td class="rdetail-info-title">Language</td>'+`<td class="rdetail-info-value">${i.long} (${i.short})</td></tr>`:"")+'<tr class="rdetail-info"><td class="rdetail-info-title">UUID</td>'+`<td class="rdetail-info-value">${e.id}</td></tr>`+'<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>',d=t=>{let s=$(`.rdetail-info > .rdetail-info-value > .rat[data-rat-uuid="${t.meta.searchId}"]`);if(t.data.length>0){let a=t.data[0];s.html(a.CMDRname+(e.platform===a.platform?"":` <span class="badge badge-yellow">BAD PLATFORM: RAT IS ${a.platform.toUpperCase()}</span>`))}else s.html("<i>Rat not found!</i>")},l=e=>{window.console.error("fr.client.UpdateRescueDetail - Rat info error: ",e);"object"==typeof e&&"object"==typeof e.meta&&"string"==typeof e.meta.searchId&&$(`.rdetail-info > .rdetail-info-value > .rat[data-rat-uuid="${e.meta.searchId}"]`).html("<i>Connection Error</i>")},r=[];for(let t in e.rats)e.rats.hasOwnProperty(t)&&(this.FetchRatInfo(e.rats[t]).then(d).catch(l),r.push(`<span class="rat" data-rat-uuid="${e.rats[t]}"><i>Loading</i></span>`));for(let t in e.unidentifiedRats)e.unidentifiedRats.hasOwnProperty(t)&&r.push(`<span class="rat-unidentified">${e.unidentifiedRats[t]}</span> <span class="badge badge-yellow">unidentified</span>`);if(r.length>0){if(o+='<tr class="rdetail-info"><td class="rdetail-info-title">Rats</td><td class="rdetail-info-value tbl-border-box">'+r[0]+"</td></tr>",r.length>1)for(let e=1;e<r.length;e++)o+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${r[e]}</td></tr>`;o+='<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>'}if(e.quotes.length>0&&(o+=`<tr class="rdetail-info"><td class="rdetail-info-title">Quotes</td><td class="rdetail-info-value tbl-border-box">${e.quotes[0]}</td></tr>`,e.quotes.length>1))for(let t=1;t<e.quotes.length;t++)o+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${e.quotes[t]}</td></tr>`;o+="</tbody></table>",window.console.debug(`fr.client.UpdateRescueDetail - Rescue DetailView Updated: ${e.id} : ${e.client}`),this.setHtml("#rescueDetailContent",o),$(`button.btn.btn-detail[data-rescue-sid="${e.id.split("-")[0]}"]`).addClass("active"),$("body").addClass("rdetail-active"),e.system&&(window.console.debug("fr.client.UpdateRescueDetail - Checking sysapi for additional system info."),this.getSystemHtml(e).then(t=>{this.setHtml(`span[data-system-name="${e.system.toUpperCase()}"]`,t)}).catch(()=>{this.setHtml(`span[data-system-name="${e.system.toUpperCase()}"]`,'<a target="_blank" href="https://www.eddb.io/"><span class="badge badge-red" title="Go to EDDB.io" >NOT IN EDDB</span></a>')}))},getSystemHtml:function(e){return e?this.sysApi.get(e.system).then(e=>{window.console.debug("this.UpdateRescueDetail - Additional info found! Adding system-related warnings and eddb link.");let t=e;t.attributes.name.toUpperCase();let s="";t.attributes.needs_permit&&1===t.attributes.needs_permit&&(s+='<span class="badge badge-yellow" title="This system requires a permit!">PERMIT</span> ');t.attributes.is_populated&&1===t.attributes.is_populated&&(s+=' <span class="badge badge-yellow" title="This system is populated, check for stations!">POPULATED</span> ');if(t.bodies&&t.bodies.length>0){let e=t.bodies.find(function(e){return e.attributes.is_main_star});e&&fr.const.scoopables.includes(e.attributes.spectral_class)?s+=' <span class="badge badge-yellow" title="This system\'s main star is scoopable!">SCOOPABLE</span> ':t.bodies.length>1&&t.bodies.filter(function(e){return fr.const.scoopables.includes(e.attributes.spectral_class)}).length>0&&(s+=' <span class="badge badge-yellow" title="This system contains a scoopable star!">SCOOPABLE [SECONDARY]</span> ')}t.id&&(s+=`<a target="_blank" href="https://www.eddb.io/system/${t.id}"><span class="badge badge-green" title="View on EDDB.io" >EDDB</span></a>`);return Promise.resolve(s)}):Promise.reject("")},setHtml:function(e,t){$(e).animate({opacity:.2},100).html(t).animate({opacity:1},500)},replaceHtml:function(e,t){$(e).replaceWith(t),$(e).animate({opacity:.2},100).animate({opacity:1},500)},appendHtml:function(e,t){$(e).append(t)}};