fr.client={clipboard:null,CachedRescues:{},SelectedRescue:null,initComp:!1,socket:null,sysApi:null,theme:"default",init:function(){this.initComp?window.console.debug("fr.client.init - init completed already!"):(window.console.debug("fr.client.init - Client manager loaded."),$("#navbar-brand-title").text(fr.config.WebPageTitle),window.onpopstate=this.HandlePopState,window.onbeforeunload=(()=>{window.localStorage.setItem(`${fr.config.AppNamespace}.window.theme`,$("body").attr("style"))}),window.localStorage.getItem(`${fr.config.AppNamespace}.window.theme`)?this.theme=window.localStorage.getItem(`${fr.config.AppNamespace}.window.theme`):window.localStorage.setItem(`${fr.config.AppNamespace}.window.theme`,"default"),"default"!==this.theme&&$("body").attr("style",this.theme),$("body").on("click","button.btn.btn-detail",t=>{this.SetSelectedRescue(t.currentTarget.dataset.rescueSid)}).on("click",".class-toggle",t=>{$(t.currentTarget.dataset.target).toggleClass(t.currentTarget.dataset.targetClass)}).on("click","a.panel-settings-toggle",t=>{window.alert("This doesn't do anything yet. lol!");t.preventDefault()}),Clipboard.isSupported()&&(this.clipboard=new Clipboard(".btn-clipboard"),$("body").addClass("clipboard-enable")),this.sysApi=new StarSystems,this.socket=new RatSocket(fr.config.WssURI),this.socket.on("ratsocket:reconnect",t=>this.handleReconnect(t)).on("rescueCreated",(t,e)=>{e.included&&(e=Util.mapRelationships(e));this.AddRescue(t,e.data)}).on("rescueUpdated",(t,e)=>{e.included&&(e=Util.mapRelationships(e));for(let s=0;s<e.data.length;s+=1)this.UpdateRescue(t,e.data[s])}).connect(fr.user.AuthHeader).then(()=>this.socket.subscribe("0xDEADBEEF")).then(()=>this.socket.request({action:["rescues","read"],status:{$not:"closed"}})).then(t=>this.PopulateBoard(t.context,t.data)).catch(t=>window.console.error(t)),this.UpdateClocks(),this.initComp=!0)},handleReconnect:function(t){t.request({action:["rescues","read"],status:{$not:"closed"},meta:{updateList:"true"}}).then(t=>{}).catch(t=>{window.console.error("fr.client.handleReconnect - reconnect data update failed!",t)})},PopulateBoard:function(t,e){let s=e.data;for(let e in s)s.hasOwnProperty(e)&&this.AddRescue(t,s[e]);this.ParseQueryString(),$("body").removeClass("loading")},FetchRatInfo:function(t){if(sessionStorage.getItem(`${fr.config.AppNamespace}.rat.${t}`)){let e=JSON.parse(sessionStorage.getItem(`${fr.config.AppNamespace}.rat.${t}`));return window.console.debug("fr.client.FetchRatInfo - Cached Rat Requested: ",e),Promise.resolve(e)}return window.console.debug(`fr.client.FetchRatInfo - Gathering RatInfo: ${t}`),this.socket.request({action:"rats:read",data:{id:t},meta:{searchId:t}}).then(e=>{sessionStorage.setItem(`${fr.config.AppNamespace}.rat.${t}`,JSON.stringify(e.data));return Promise.resolve(e.data)})},ParseQueryString:function(){let t=$.getUrlParam("a");t&&this.CachedRescues[t]?this.SetSelectedRescue(t,!0):history.replaceState&&window.history.replaceState({a:null},document.title,window.location.pathname)},HandlePopState:function(t){this.SetSelectedRescue(t.state.a,!0)},AddRescue:function(t,e){if(!e)return;let s=e,a=s.id.split("-")[0];$(`tr.rescue[data-rescue-sid="${a}"]`).length>0?this.UpdateRescue(s):(window.console.debug("fr.client.AddRescue: Rescue Added to board."),this.CachedRescues[a]=s,this.appendHtml("#rescueTable",this.GetRescueTableRow(s)),"string"==typeof s.attributes.system&&this.sysApi.get(s.attributes.system).then(()=>{window.console.debug("fr.client.AddRescue - Additional info found! Caching...")}).catch(()=>{window.console.debug("fr.client.AddRescue - No additional system information found.")}))},UpdateRescue:function(t,e){if(!e)return;let s=e,a=s.id.split("-")[0],i=$(`tr.rescue[data-rescue-sid="${a}"]`);return i.length<1?(window.console.debug("fr.client.UpdateRescue: Attempted to update a non-existent rescue: ",s),void this.AddRescue(t,s)):"closed"===s.attributes.state?(setTimeout(function(){i.hide("slow").remove()},5e3),window.console.debug(`fr.client.UpdateRescue - Rescue Removed: ${s.id} : `,s),s.id&&this.SelectedRescue&&s.id===this.SelectedRescue.id&&this.SetSelectedRescue(null),void delete this.CachedRescues[a]):(window.console.debug(`fr.client.UpdateRescue - Rescue Updated: ${s.id} : `,s),this.replaceHtml(`tr.rescue[data-rescue-sid="${a}"]`,this.GetRescueTableRow(s)),this.CachedRescues[a]=s,void(s.id&&this.SelectedRescue&&s.id===this.SelectedRescue.id&&(window.console.debug(`fr.client.UpdateRescue - Rescue DetailView Updating: ${s.id} : `,s),this.SelectedRescue=s,this.UpdateRescueDetail())))},GetRescueTableRow:function(t){if(!t)return;let e=t.id.split("-")[0],s=void 0===t.relationships.rats.data?t.relationships.rats:{},a=[];for(let e in s)s.hasOwnProperty(e)&&a.push(`<span class="rat" data-rat-uuid="${e}">${t.relationships.rats[e].attributes.name}</span>`);for(let e of t.attributes.unidentifiedRats)a.push(`<span class="rat-unidentified">${e}</span> <span class="badge badge-yellow">unidentified</span>`);let i=t.attributes.data.langID?fr.const.language[t.attributes.data.langID]?fr.const.language[t.attributes.data.langID]:{short:t.attributes.data.langID,long:t.attributes.data.langID}:fr.const.language.unknown,n=t.attributes.platform?fr.const.platform[t.attributes.platform]:fr.const.platform.unknown,o=$(`<tr class="rescue" data-rescue-sid="${e}">`+`<td class="rescue-row-index">${"number"==typeof t.attributes.data.boardIndex?t.attributes.data.boardIndex:"?"}</td>`+`<td class="rescue-row-client" title="${t.attributes.data.IRCNick||""}">${t.attributes.client||"?"}</td>`+`<td class="rescue-row-language" title="${i.long}">${i.short}</td>`+`<td class="rescue-row-platform" title="${n.long}">${n.short}</td>`+`<td class="rescue-row-system btn-clipboard" data-clipboard-text="${t.attributes.system||"Unknown"}">${t.attributes.system||"Unknown"} <i class="fa fa-clipboard" title="Click to Copy!"></i></td>`+`<td class="rescue-row-rats">${a.join(", ")}</td>`+`<td class="rescue-row-detail"><button type="button" class="btn btn-detail" data-rescue-sid="${e}"><span class="fa fa-info" aria-hidden="true"></span></button></td>`+"</tr>");return t.attributes.codeRed?o.addClass("rescue-codered"):o.removeClass("rescue-codered"),"inactive"===t.attributes.status?o.addClass("rescue-inactive"):o.removeClass("rescue-inactive"),o.attr("title",null!==t.attributes.quotes?t.attributes.quotes.map(t=>`[${t.createdAt}] "${t.message}" - ${t.author}`).join("\n"):"No known quotes...."),o},UpdateClocks:function(){let t=new Date;$(".ed-clock").text(Util.getDateHumanReadable(t)),null!==this.SelectedRescue&&$(".rdetail-timer").text(Util.getTimeSpanString(t,Date.parse(this.SelectedRescue.attributes.createdAt))).prop("title","Last Updated: "+Util.getTimeSpanString(t,Date.parse(this.SelectedRescue.attributes.updatedAt))),setTimeout(()=>{this.UpdateClocks()},1e3-t.getMilliseconds())},SetSelectedRescue:function(t,e){if(null===t||this.SelectedRescue&&t.toString()===this.SelectedRescue.id.split("-")[0])return this.SelectedRescue=null,history.pushState&&!e&&window.history.pushState({a:null},document.title,window.location.pathname),void this.UpdateRescueDetail();this.CachedRescues[t]?(window.console.debug(`fr.client.SetSelectedRescue - New SelectedRescue: ${this.CachedRescues[t].id}`),this.SelectedRescue=this.CachedRescues[t],history.pushState&&!e&&window.history.pushState({a:t},document.title,window.location.pathname+`?a=${encodeURIComponent(t)}`),this.UpdateRescueDetail()):window.console.error(`fr.client.SetSelectedRescue - invalid key: ${t}`)},UpdateRescueDetail:function(){if($("button.btn-detail.active").removeClass("active"),!this.SelectedRescue)return void $("body").removeClass("rdetail-active");let t=this.SelectedRescue,e="number"==typeof t.attributes.data.boardIndex?`#${t.attributes.data.boardIndex} - `:"",s=t.attributes.title?t.attributes.title:t.attributes.client,a=(t.attributes.codeRed?' <span class="badge badge-red">Code Red</span>':"")+("inactive"===t.attributes.status?' <span class="badge badge-yellow">Inactive</span>':""),i=t.attributes.data.langID?fr.const.language[t.attributes.data.langID]?fr.const.language[t.attributes.data.langID]:{short:t.attributes.data.langID,long:t.attributes.data.langID}:fr.const.language.unknown,n=t.attributes.platform?fr.const.platform[t.attributes.platform]:fr.const.platform.unknown,o=`<div class="rdetail-header"><div class="rdetail-title">${e+s+a}</div><div class="rdetail-timer">00:00:00</div></div>`+'<table class="rdetail-body table table-rescue"><thead><td width="90px"></td><td></td></thead><tbody>'+(t.attributes.data.IRCNick?'<tr class="rdetail-info"><td class="rdetail-info-title">IRC Nick</td>'+`<td class="rdetail-info-value">${t.attributes.data.IRCNick}</td></tr>`:"")+(t.attributes.system?'<tr class="rdetail-info"><td class="rdetail-info-title">System</td>'+`<td class="rdetail-info-value">${t.attributes.system}`+`<span class="float-right system-apidata" data-system-name="${t.attributes.system.toUpperCase()}"><i>Retrieving info...</i></span></td></tr>`:"")+(t.attributes.platform?'<tr class="rdetail-info"><td class="rdetail-info-title">Platform</td>'+`<td class="rdetail-info-value">${n.long}</td></tr>`:"")+(t.attributes.data.langID?'<tr class="rdetail-info"><td class="rdetail-info-title">Language</td>'+`<td class="rdetail-info-value">${i.long} (${i.short})</td></tr>`:"")+'<tr class="rdetail-info"><td class="rdetail-info-title">UUID</td>'+`<td class="rdetail-info-value">${t.id}</td></tr>`+'<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>',d=void 0===t.relationships.rats.data?t.relationships.rats:{},r=[];for(let e in d)d.hasOwnProperty(e)&&r.push(`<span class="rat" data-rat-uuid="${e}">${d[e].attributes.name} ${d[e].attributes.platform!==t.attributes.platform?'<span class="badge badge-yellow">Wrong Platform!</span>':""}</span>`);for(let e of t.attributes.unidentifiedRats)r.push(`<span class="rat-unidentified">${e}</span> <span class="badge badge-yellow">unidentified</span>`);if(r.length>0){if(o+='<tr class="rdetail-info"><td class="rdetail-info-title">Rats</td><td class="rdetail-info-value tbl-border-box">'+r[0]+"</td></tr>",r.length>1)for(let t=1;t<r.length;t++)o+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${r[t]}</td></tr>`;o+='<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>'}if(t.attributes.quotes&&t.attributes.quotes.length>0){let e=[];for(let s of t.attributes.quotes)e.push(`[${Util.getDateHumanReadable(new Date(s.createdAt))}] "${s.message}" - ${s.lastAuthor}`);if(o+=`<tr class="rdetail-info"><td class="rdetail-info-title">Quotes</td><td class="rdetail-info-value tbl-border-box">${e[0]}</td></tr>`,e.length>1)for(let t=1;t<e.length;t++)o+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${e[t]}</td></tr>`}o+="</tbody></table>",window.console.debug(`fr.client.UpdateRescueDetail - Rescue DetailView Updated: ${t.id} :`,t),this.setHtml("#rescueDetailContent",o),$(`button.btn.btn-detail[data-rescue-sid="${t.id.split("-")[0]}"]`).addClass("active"),$("body").addClass("rdetail-active"),t.attributes.system&&(window.console.debug("fr.client.UpdateRescueDetail - Checking sysapi for additional system info."),this.getSystemHtml(t).then(e=>{this.setHtml(`span[data-system-name="${t.attributes.system.toUpperCase()}"]`,e)}).catch(()=>{this.setHtml(`span[data-system-name="${t.attributes.system.toUpperCase()}"]`,'<a target="_blank" href="https://www.eddb.io/"><span class="badge badge-red" title="Go to EDDB.io" >NOT IN EDDB</span></a>')}))},getSystemHtml:function(t){return t?this.sysApi.get(t.attributes.system).then(t=>{window.console.debug("this.UpdateRescueDetail - Additional info found! Adding system-related warnings and eddb link.");let e=t;e.attributes.name.toUpperCase();let s="";e.attributes.needs_permit&&1===e.attributes.needs_permit&&(s+='<span class="badge badge-yellow" title="This system requires a permit!">PERMIT</span> ');e.attributes.is_populated&&1===e.attributes.is_populated&&(s+=' <span class="badge badge-yellow" title="This system is populated, check for stations!">POPULATED</span> ');if(e.bodies&&e.bodies.length>0){let t=e.bodies.find(function(t){return t.attributes.is_main_star});t&&fr.const.scoopables.includes(t.attributes.spectral_class)?s+=' <span class="badge badge-yellow" title="This system\'s main star is scoopable!">SCOOPABLE</span> ':e.bodies.length>1&&e.bodies.filter(function(t){return fr.const.scoopables.includes(t.attributes.spectral_class)}).length>0&&(s+=' <span class="badge badge-yellow" title="This system contains a scoopable star!">SCOOPABLE [SECONDARY]</span> ')}e.id&&(s+=`<a target="_blank" href="https://www.eddb.io/system/${e.id}"><span class="badge badge-green" title="View on EDDB.io" >EDDB</span></a>`);return Promise.resolve(s)}):Promise.reject("")},setHtml:function(t,e){$(t).animate({opacity:.2},100).html(e).animate({opacity:1},500)},replaceHtml:function(t,e){$(t).replaceWith(e),$(t).animate({opacity:.2},100).animate({opacity:1},500)},appendHtml:function(t,e){$(t).append(e)}};