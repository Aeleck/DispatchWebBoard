fr.client=fr.config&&fr.ws&&fr.sysapi?{clipboard:null,CachedRescues:{},SelectedRescue:null,initComp:!1,init:function(){this.initComp?window.console.debug("fr.client.init - init completed already!"):(window.console.debug("fr.client.init - this loaded. DEBUG MODE ACTIVE."),window.onpopstate=this.HandlePopState,fr.ws.onTPA=(e=>this.handleTPA(e)),fr.ws.onReconnect=(()=>this.handleReconnect()),fr.ws.send("rescues:read",{open:"true"},{}),this.UpdateClocks(),$("#navbar-brand-title").text(fr.config.WebPageTitle),$("body").on("click","button.btn.btn-detail",e=>{this.SetSelectedRescue(e.currentTarget.dataset.rescueSid)}).on("click","button.btn.btn-nav-toggle",e=>{$(e.currentTarget.dataset.target).toggleClass("expand");$(e.currentTarget).toggleClass("active")}),Clipboard.isSupported()&&(this.clipboard=new Clipboard(".btn-clipboard"),$("body").addClass("clipboard-enable")),this.initComp=!0)},handleTPA:function(e){switch(window.console.debug("fr.client.handleTPA - New TPA: ",e),e.meta.action){case"rescues:read":this.AddExistingRescues(e.data);break;case"rescue:created":this.AddRescue(e.data);break;case"rescue:updated":this.UpdateRescue(e.data);break;case"rats:read":window.console.error("fr.client.handleTPA - Uncaught rats:read passed to TPA handler: ",e);break;case"welcome":case"stream:subscribe":case"authorization":break;default:window.console.error("fr.client.handleTPA - Unhandled TPA: ",e)}},handleReconnect:function(){fr.ws.send("rescues:read",{open:"true"},{updateList:"true"})},AddExistingRescues:function(e){for(let t in e)e.hasOwnProperty(t)&&this.AddRescue(e[t]);this.ParseQueryString(),$("body").removeClass("loading")},FetchRatInfo:function(e){if(sessionStorage.getItem("rat."+e)){let t=JSON.parse(sessionStorage.getItem(`rat.${e}`));return window.console.debug("fr.client.FetchRatInfo - Cached Rat Requested: ",t),Promise.resolve(t)}return window.console.debug(`fr.client.FetchRatInfo - Gathering RatInfo: ${e}`),fr.ws.sendRequest("rats:read",{id:e},{searchId:e}).then(t=>{sessionStorage.setItem("rat."+e,JSON.stringify(t));return Promise.resolve(t)})},ParseQueryString:function(){let e=$.getUrlParam("a");e&&this.CachedRescues[e]?this.SetSelectedRescue(e,!0):history.replaceState&&window.history.replaceState({a:null},document.title,window.location.pathname)},HandlePopState:function(e){this.SetSelectedRescue(e.state.a,!0)},AddRescue:function(e){if(!e)return;let t=e,a=t.id.split("-")[0];null===t.data&&(t.data={}),null===t.system&&(t.system=""),$('tr.rescue[data-rescue-sid="'+a+'"]').length>0?this.UpdateRescue(t):(window.console.debug("fr.client.AddRescue: Rescue Added to board."),this.CachedRescues[a]=t,$("#rescueTable").append(this.GetRescueTableRow(t)))},UpdateRescue:function(e){if(!e)return;let t=e,a=t.id.split("-")[0],s=$('tr.rescue[data-rescue-sid="'+a+'"]');if(s){if(!t.open)return setTimeout(function(){s.hide("slow").remove()},5e3),window.console.debug("fr.client.UpdateRescue - Rescue Removed: "+t.id+" : "+t.client),t.id&&this.SelectedRescue&&t.id===this.SelectedRescue.id&&this.SetSelectedRescue(null),void delete this.CachedRescues[a];window.console.debug("fr.client.UpdateRescue - Rescue Updated: "+t.id+" : "+t.client),s.replaceWith(this.GetRescueTableRow(e)),$('tr.rescue[data-rescue-sid="'+a+'"]').animate({opacity:.2},100).animate({opacity:1},500),this.CachedRescues[a]=t,t.id&&this.SelectedRescue&&t.id===this.SelectedRescue.id&&(window.console.debug("fr.client.UpdateRescue - Rescue DetailView Updating: "+t.id+" : "+t.client),this.SelectedRescue=t,this.UpdateRescueDetail())}else window.console.debug("fr.client.UpdateRescue: Attempted to update a non-existant rescue: ",t)},GetRescueTableRow:function(e){if(!e)return;let t=e=>{let t=$('.rescue-row-rats > .rat[data-rat-uuid="'+e.meta.searchId+'"]');if(e.data.length>0){let a=e.data[0];t.text(a.CMDRname)}else t.html("<i>Rat not found!</i>").attr("title",e.meta.searchId)},a=e=>{window.console.log("fr.client.UpdateRescueDetail - Rat info error: ",e);"object"==typeof e&&"object"==typeof e.meta&&"string"==typeof e.meta.searchId&&$('.rescue-row-rats > .rat[data-rat-uuid="'+e.meta.searchId+'"]').html("<i>Connection Error</i>").attr("title",e.meta.searchId)},s=e.id.split("-")[0],i=e.rats,n=[];for(let s in i)i.hasOwnProperty(s)&&(this.FetchRatInfo(i[s]).then(t).catch(a),n.push(`<span class="rat" data-rat-uuid="${e.rats[s]}"><i>Loading</i></span>`));for(let t in e.unidentifiedRats)e.unidentifiedRats.hasOwnProperty(t)&&n.push(`<span class="rat-unidentified"><i>${e.unidentifiedRats[t]}</i></span>`);let d=e.data.langID?fr.const.language[e.data.langID]?fr.const.language[e.data.langID]:{short:e.data.langID,long:e.data.langID}:fr.const.language.unknown,o=e.platform?fr.const.platform[e.platform]:fr.const.platform.unknown,r=$(`<tr class="rescue" data-rescue-sid="${s}">`+`<td class="rescue-row-index">${e.data.boardIndex||"?"}</td>`+`<td class="rescue-row-client" title="${e.data.IRCNick||""}">${e.client||"?"}</td>`+`<td class="rescue-row-language" title="${d.long}">${d.short}</td>`+`<td class="rescue-row-platform" title="${o.long}">${o.short}</td>`+`<td class="rescue-row-system btn-clipboard" data-clipboard-text="${e.system}">${e.system} <i class="fa fa-clipboard" title="Click to Copy!"></i></td>`+`<td class="rescue-row-rats">${n.join(", ")}</td>`+`<td class="rescue-row-detail"><button type="button" class="btn btn-detail" data-rescue-sid="${s}"><span class="fa fa-info" aria-hidden="true"></span></button></td>`+"</tr>");e.epic?r.addClass("rescue-epic"):r.removeClass("rescue-epic"),e.codeRed?r.addClass("rescue-codered"):r.removeClass("rescue-codered"),e.active?r.removeClass("rescue-inactive"):r.addClass("rescue-inactive");let l=e.quotes.join("\n");return r.attr("title",l),r},UpdateClocks:function(){let e=new Date;$(".ed-clock").text(e.getUTCFullYear()+1286+" "+fr.const.monthString[e.getUTCMonth()]+" "+(e.getUTCDate()<10?"0":"")+e.getUTCDate()+" "+(e.getUTCHours()<10?"0":"")+e.getUTCHours()+":"+(e.getUTCMinutes()<10?"0":"")+e.getUTCMinutes()+":"+(e.getUTCSeconds()<10?"0":"")+e.getUTCSeconds()),null!==this.SelectedRescue&&($(".rdetail-timer").text(getTimeSpanString(e,Date.parse(this.SelectedRescue.createdAt))),$(".rdetail-timer").prop("title","Last Updated: "+getTimeSpanString(e,Date.parse(this.SelectedRescue.updatedAt)))),setTimeout(()=>{this.UpdateClocks()},1e3-e.getMilliseconds())},SetSelectedRescue:function(e,t){if(null===e||this.SelectedRescue&&e.toString()===this.SelectedRescue.id.split("-")[0])return this.SelectedRescue=null,history.pushState&&!t&&window.history.pushState({a:null},document.title,window.location.pathname),void this.UpdateRescueDetail();this.CachedRescues[e]?(window.console.debug(`fr.client.SetSelectedRescue - New SelectedRescue: ${this.CachedRescues[e].id}`),this.SelectedRescue=this.CachedRescues[e],history.pushState&&!t&&window.history.pushState({a:e},document.title,window.location.pathname+`?a=${encodeURIComponent(e)}`),this.UpdateRescueDetail()):window.console.log(`fr.client.SetSelectedRescue - invalid key: ${e}`)},UpdateRescueDetail:function(){if($("button.btn-detail.active").removeClass("active"),!this.SelectedRescue)return void $("body").removeClass("rdetail-active");let e=this.SelectedRescue,t="number"==typeof e.data.boardIndex?`#${e.data.boardIndex} - `:"",a=e.title?e.title:e.client,s=(e.codeRed?' <span class="badge badge-red">Code Red</span>':"")+(e.active?"":' <span class="badge badge-yellow">Inactive</span>'),i=e.data.langID?fr.const.language[e.data.langID]?fr.const.language[e.data.langID]:{short:e.data.langID,long:e.data.langID}:fr.const.language.unknown,n=e.platform?fr.const.platform[e.platform]:fr.const.platform.unknown,d=`<div class="rdetail-header"><div class="rdetail-title">${t+a+s}</div><div class="rdetail-timer">00:00:00</div></div>`+'<table class="rdetail-body table table-rescue"><thead><td width="90px"></td><td></td></thead><tbody>'+(e.data.IRCNick?'<tr class="rdetail-info"><td class="rdetail-info-title">IRC Nick</td>'+`<td class="rdetail-info-value">${e.data.IRCNick}</td></tr>`:"")+(e.system?'<tr class="rdetail-info"><td class="rdetail-info-title">System</td>'+`<td class="rdetail-info-value">${e.system}`+`<span class="float-right system-apidata" data-system-name="${e.system.toUpperCase()}"><i>Retrieving info...</i></span></td></tr>`:"")+(e.platform?'<tr class="rdetail-info"><td class="rdetail-info-title">Platform</td>'+`<td class="rdetail-info-value">${n.long}</td></tr>`:"")+(e.data.langID?'<tr class="rdetail-info"><td class="rdetail-info-title">Language</td>'+`<td class="rdetail-info-value">${i.long} (${i.short})</td></tr>`:"")+'<tr class="rdetail-info"><td class="rdetail-info-title">UUID</td>'+`<td class="rdetail-info-value">${e.id}</td></tr>`+'<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>',o=t=>{let a=$('.rdetail-info > .rdetail-info-value > .rat[data-rat-uuid="'+t.meta.searchId+'"]');if(t.data.length>0){let s=t.data[0];a.html(s.CMDRname+(e.platform===s.platform?"":` <span class="badge badge-yellow">BAD PLATFORM: RAT IS ${s.platform.toUpperCase()}</span>`))}else a.html("<i>Rat not found!</i>")},r=e=>{window.console.log("fr.client.UpdateRescueDetail - Rat info error: ",e);"object"==typeof e&&"object"==typeof e.meta&&"string"==typeof e.meta.searchId&&$('.rdetail-info > .rdetail-info-value > .rat[data-rat-uuid="'+e.meta.searchId+'"]').html("<i>Connection Error</i>")},l=[];for(let t in e.rats)e.rats.hasOwnProperty(t)&&(this.FetchRatInfo(e.rats[t]).then(o).catch(r),l.push(`<span class="rat" data-rat-uuid="${e.rats[t]}"><i>Loading</i></span>`));for(let t in e.unidentifiedRats)e.unidentifiedRats.hasOwnProperty(t)&&l.push('<span class="rat-unidentified">'+e.unidentifiedRats[t]+'</span> <span class="badge badge-yellow">unidentified</span>');if(l.length>0){if(d+='<tr class="rdetail-info"><td class="rdetail-info-title">Rats</td><td class="rdetail-info-value tbl-border-box">'+l[0]+"</td></tr>",l.length>1)for(let e=1;e<l.length;e++)d+='<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">'+l[e]+"</td></tr>";d+='<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>'}if(e.quotes.length>0&&(d+=`<tr class="rdetail-info"><td class="rdetail-info-title">Quotes</td><td class="rdetail-info-value tbl-border-box">${e.quotes[0]}</td></tr>`,e.quotes.length>1))for(let t=1;t<e.quotes.length;t++)d+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${e.quotes[t]}</td></tr>`;d+="</tbody></table>",window.console.debug(`fr.client.UpdateRescueDetail - Rescue DetailView Updated: ${e.id} : ${e.client}`),$("#rescueDetailContent").animate({opacity:.2},100).html(d).animate({opacity:1},500),$(`button.btn.btn-detail[data-rescue-sid="${e.id.split("-")[0]}"]`).addClass("active"),$("body").addClass("rdetail-active"),e.system&&(window.console.debug("fr.client.UpdateRescueDetail - Checking sysapi for additional system info."),fr.sysapi.GetSysInfo(e.system).then(e=>{window.console.debug("this.UpdateRescueDetail - Additional info found! Adding system-related warnings and eddb link.");let t=e;let a=t.attributes.name.toUpperCase();let s="";t.attributes.needs_permit&&1===t.attributes.needs_permit&&(s+='<span class="badge badge-yellow" title="This system requires a permit!">PERMIT</span> ');t.attributes.is_populated&&1===t.attributes.is_populated&&(s+=' <span class="badge badge-yellow" title="This system is populated, check for stations!">POPULATED</span> ');if(t.bodies&&t.bodies.length>0){let e=t.bodies.find(function(e){return e.attributes.is_main_star});e&&fr.const.scoopables.includes(e.attributes.spectral_class)?s+=' <span class="badge badge-yellow" title="This system\'s main star is scoopable!">SCOOPABLE</span> ':t.bodies.length>1&&t.bodies.filter(function(e){return fr.const.scoopables.includes(e.attributes.spectral_class)}).length>0&&(s+=' <span class="badge badge-yellow" title="This system contains a scoopable star!">SCOOPABLE [SECONDARY]</span> ')}t.id&&(s+=`<a target="_blank" href="https://www.eddb.io/system/${t.id}"><span class="badge badge-green" title="View on EDDB.io" >EDDB</span></a>`);$(`span[data-system-name="${a}"]`).animate({opacity:.2},100).html(s).animate({opacity:1},500)}).catch(()=>{$(`span[data-system-name="${e.system.toUpperCase()}"]`).animate({opacity:.2},100).html('<a target="_blank" href="https://www.eddb.io/"><span class="badge badge-red" title="Go to EDDB.io" >NOT IN EDDB</span></a>').animate({opacity:1},500)}))}}:null;