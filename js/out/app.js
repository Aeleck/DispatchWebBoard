fr.const={platform:{pc:{short:"PC",long:"PC"},xb:{short:"XB1",long:"Xbox One"},ps:{short:"PS4",long:"Playstation 4"},unknown:{short:"?",long:"Unknown..."}},language:{bg:{short:"BG",long:"Bulgarian"},bs:{short:"BS",long:"Bosnian"},ca:{short:"CA",long:"Catalan / Valencian"},cs:{short:"CS",long:"Czech"},da:{short:"DA",long:"Danish"},de:{short:"DE",long:"German"},el:{short:"EL",long:"Modern Greek"},en:{short:"EN",long:"English"},es:{short:"ES",long:"Spanish / Castilian"},et:{short:"ET",long:"Estonian"},fi:{short:"FI",long:"Finnish"},fr:{short:"FR",long:"French"},he:{short:"HE",long:"Modern Hebrew"},hr:{short:"HR",long:"Croatian"},hu:{short:"HU",long:"Hungarian"},it:{short:"IT",long:"Italian"},ja:{short:"JA",long:"Japanese"},lt:{short:"LT",long:"Lithuanian"},lv:{short:"LV",long:"Latvian"},nb:{short:"NB",long:"Norwegian BokmÃ¥l"},nv:{short:"NV",long:"Navajo, Navaho"},nl:{short:"NL",long:"Dutch"},pl:{short:"PL",long:"Polish"},pt:{short:"PT",long:"Portuguese"},ro:{short:"RO",long:"Romanian, Moldavian, Moldovan"},ru:{short:"RU",long:"Russian"},sk:{short:"SK",long:"Slovak"},sl:{short:"SL",long:"Slovene"},sr:{short:"SR",long:"Serbian"},sv:{short:"SV",long:"Swedish"},th:{short:"TH",long:"Thai"},tr:{short:"TR",long:"Turkish"},uk:{short:"UK",long:"Ukrainian"},unknown:{short:"?",long:"Unknown..."},zh:{short:"ZH",long:"Chinese"}},scoopables:["O","B","A","F","G","K","M"],monthString:["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"]};(function(exports){"use strict";function Util(){}Util.GetCookie=function GetCookie(name){try{let cookie=document.cookie;let valueStart=cookie.indexOf(name+"=")+1;if(valueStart===0){return null}valueStart+=name.length;let valueEnd=cookie.indexOf(";",valueStart);if(valueEnd===-1){valueEnd=cookie.length}return decodeURIComponent(cookie.substring(valueStart,valueEnd))}catch(e){}return null};Util.SetCookie=function SetCookie(name,value,expire){let temp=name+"="+encodeURIComponent(value)+(expire!==0?"; path=/; expires="+new Date((new Date).getTime()+expire).toUTCString()+";":"; path=/;");document.cookie=temp};Util.DelCookie=function DelCookie(name){document.cookie=name+"=0; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;"};Util.CanSetCookies=function CanSetCookies(){Util.SetCookie("CookieTest","true",0);let can=Util.GetCookie("CookieTest")!==null;Util.DelCookie("CookieTest");return can};Util.isValidProperty=function isValidProperty(obj,key,ktype){let isValidType=function(item,type){if(type==="array"){return Array.isArray(item)}else if(type==="object"){return Util.isObject(item)}else{return typeof item===type}};return obj.hasOwnProperty(key)&&(!Array.isArray(ktype)?isValidType(obj[key],ktype):ktype.some(i=>isValidType(obj[key],i)))};Util.isObject=function isObject(object){return object!=null&&typeof object==="object"&&Object.prototype.toString.call(object)==="[object Object]"};Util.mapRelationships=function mapRelationships(data){if(!Util.isObject(data)||!Util.isValidProperty(data,"data",["array","object"])||!Util.isValidProperty(data,"included","array")){throw TypeError("Invalid data model")}function findInclude(member,included){let includeMatches=included.filter(obj=>!obj.id||!obj.type?false:obj.id===member.id&&obj.type===member.type);if(includeMatches.length>1){window.console.error("fr.user.mapProfileRelationships.findInclude - Multiple matches to included filter: ",includeMatches)}return includeMatches[0]}function mapRelationshipItems(relationships,included){if(!Util.isObject(relationships)||!Array.isArray(included)){throw TypeError("Invalid Parameters")}for(let relType in relationships){if(!relationships.hasOwnProperty(relType)){continue}if(Array.isArray(relationships[relType].data)&&relationships[relType].data.length>0){let typeMembers=relationships[relType].data;for(let i=0;i<typeMembers.length;i+=1){let member=typeMembers[i];if(member&&member.id&&member.type){relationships[relType][member.id]=findInclude(member,included);if(relationships[relType][member.id].hasOwnProperty("relationships")){relationships[relType][member.id].relationships=mapRelationshipItems(relationships[relType][member.id].relationships,included)}}}}else if(Util.isObject(relationships[relType].data)){let member=relationships[relType].data;if(member.id&&member.type){relationships[relType][member.id]=findInclude(member,included);if(relationships[relType][member.id].hasOwnProperty("relationships")){relationships[relType][member.id].relationships=mapRelationshipItems(relationships[relType][member.id].relationships,included)}}}delete relationships[relType].data}return relationships}if(Array.isArray(data.data)){for(let dataItem in data.data){if(!data.data.hasOwnProperty(dataItem)){continue}data.data[dataItem].relationships=mapRelationshipItems(data.data[dataItem].relationships,data.included)}}else{data.data.relationships=mapRelationshipItems(data.data.relationships,data.included)}return data};Util.getDateHumanReadable=function getDateHumanReadable(date){return date.getUTCFullYear()+1286+" "+fr.const.monthString[date.getUTCMonth()]+" "+(date.getUTCDate()<10?"0":"")+date.getUTCDate()+" "+(date.getUTCHours()<10?"0":"")+date.getUTCHours()+":"+(date.getUTCMinutes()<10?"0":"")+date.getUTCMinutes()+":"+(date.getUTCSeconds()<10?"0":"")+date.getUTCSeconds()};Util.getTimeSpanString=function getTimeSpanString(startTime,endTime){let secondsElapsed=Math.round(startTime/1e3)-Math.round(endTime/1e3);let seconds=secondsElapsed%60;secondsElapsed-=seconds;let minutes=Math.floor(secondsElapsed/60)%60;secondsElapsed-=minutes*60;let hours=Math.floor(secondsElapsed/3600);return(hours<10?"0":"")+hours+":"+(minutes<10?"0":"")+minutes+":"+(seconds<10?"0":"")+seconds};exports.Util=Util})(this||{});function selfCheck(){let validInstall=true;if(!fr.config){window.console.error("%cSLFCHK:CONFIG - ERROR","color: red; font-weight: bold;");window.console.error(fr.config);validInstall=false}if(!fr.user){window.console.error("%cSLFCHK:USER - ERROR","color: red; font-weight: bold;");window.console.error(fr.user);validInstall=false}if(!StarSystems){window.console.error("%cSLFCHK:SYSAPI - ERROR","color: red; font-weight: bold;");window.console.error(StarSystems);validInstall=false}if(!RatSocket){window.console.error("%cSLFCHK:RATSOCKET - ERROR","color: red; font-weight: bold;");window.console.error(RatSocket);validInstall=false}if(!fr.client){window.console.error("%cSLFCHK:CLIENT - ERROR","color: red; font-weight: bold;");window.console.error(fr.client);validInstall=false}if(debug){window.console.log("%cSLFCHK:DEBUG - TRUE","color: yellow;")}return validInstall}window.console.debug=debug?window.console.log.bind(window.console):function(){return false};fr.client={clipboard:null,CachedRescues:{},SelectedRescue:null,initComp:false,socket:null,sysApi:null,theme:"default",init:function(){if(this.initComp){window.console.debug("fr.client.init - init completed already!");return}window.console.debug("fr.client.init - Client manager loaded.");$("#navbar-brand-title").text(fr.config.WebPageTitle);window.onpopstate=this.HandlePopState;let themever=1;function saveTheme(){window.localStorage.setItem(`${fr.config.AppNamespace}.window.theme`,JSON.stringify({style:$("body").attr("style"),_meta:{version:themever}}))}window.onbeforeunload=(()=>{saveTheme()});if(window.localStorage.getItem(`${fr.config.AppNamespace}.window.theme`)){this.theme=JSON.parse(window.localStorage.getItem(`${fr.config.AppNamespace}.window.theme`));if(typeof this.theme!=="string"&&this.theme._meta.version===themever){$("body").attr("style",this.theme.style)}else{saveTheme()}}$("body").on("click","button.btn.btn-detail",event=>{this.SetSelectedRescue(event.currentTarget.dataset.rescueSid)}).on("click",".class-toggle",event=>{$(event.currentTarget.dataset.target).toggleClass(event.currentTarget.dataset.targetClass)}).on("click","a.panel-settings-toggle",event=>{window.alert("This doesn't do anything yet. lol!");event.preventDefault()});if(Clipboard.isSupported()){this.clipboard=new Clipboard(".btn-clipboard");$("body").addClass("clipboard-enable")}this.sysApi=new StarSystemAPI;this.socket=new RatSocket(fr.config.WssURI);this.socket.on("ratsocket:reconnect",ctx=>this.handleReconnect(ctx)).on("rescueCreated",(ctx,data)=>{if(data.included){data=Util.mapRelationships(data)}this.AddRescue(ctx,data.data)}).on("rescueUpdated",(ctx,data)=>{if(data.included){data=Util.mapRelationships(data)}for(let i=0;i<data.data.length;i+=1){this.UpdateRescue(ctx,data.data[i])}}).connect(fr.user.AuthHeader).then(()=>this.socket.subscribe("0xDEADBEEF")).then(()=>this.socket.request({action:["rescues","read"],status:{$not:"closed"}})).then(res=>this.PopulateBoard(res.context,res.data)).catch(error=>window.console.error(error));this.UpdateClocks();this.initComp=true},handleReconnect:function(ctx){ctx.request({action:["rescues","read"],status:{$not:"closed"},meta:{updateList:"true"}}).then(data=>{}).catch(error=>{window.console.error("fr.client.handleReconnect - reconnect data update failed!",error)})},PopulateBoard:function(ctx,data){let rescues=data.data;for(let i in rescues){if(rescues.hasOwnProperty(i)){this.AddRescue(ctx,rescues[i])}}this.ParseQueryString();$("body").removeClass("loading")},FetchRatInfo:function(ratId){if(sessionStorage.getItem(`${fr.config.AppNamespace}.rat.${ratId}`)){let ratData=JSON.parse(sessionStorage.getItem(`${fr.config.AppNamespace}.rat.${ratId}`));window.console.debug("fr.client.FetchRatInfo - Cached Rat Requested: ",ratData);return Promise.resolve(ratData)}else{window.console.debug(`fr.client.FetchRatInfo - Gathering RatInfo: ${ratId}`);return this.socket.request({action:"rats:read",data:{id:ratId},meta:{searchId:ratId}}).then(res=>{sessionStorage.setItem(`${fr.config.AppNamespace}.rat.${ratId}`,JSON.stringify(res.data));return Promise.resolve(res.data)})}},ParseQueryString:function(){let activeRescue=$.getUrlParam("a");if(activeRescue&&this.CachedRescues[activeRescue]){this.SetSelectedRescue(activeRescue,true)}else if(history.replaceState){window.history.replaceState({a:null},document.title,window.location.pathname)}},HandlePopState:function(event){this.SetSelectedRescue(event.state.a,true)},AddRescue:function(ctx,rescue){if(!rescue||rescue.attributes.status==="closed"){return}let sid=rescue.id.split("-")[0];if($(`tr.rescue[data-rescue-sid="${sid}"]`).length>0){this.UpdateRescue(rescue);return}window.console.debug("fr.client.AddRescue: Rescue Added to board.");this.CachedRescues[sid]=rescue;this.appendHtml("#rescueTable",this.GetRescueTableRow(rescue));if(typeof rescue.attributes.system==="string"){this.sysApi.get(rescue.attributes.system).then(()=>{window.console.debug("fr.client.AddRescue - Additional info found! Caching...")}).catch(()=>{window.console.debug("fr.client.AddRescue - No additional system information found.")})}},UpdateRescue:function(ctx,rescue){if(!rescue){return}let sid=rescue.id.split("-")[0];let rescueRow=$(`tr.rescue[data-rescue-sid="${sid}"]`);if(rescueRow.length<1){window.console.debug("fr.client.UpdateRescue: Attempted to update a non-existent rescue: ",rescue);this.AddRescue(ctx,rescue);return}if(rescue.attributes.status==="closed"){setTimeout(function(){rescueRow.hide("slow").remove()},5e3);window.console.debug(`fr.client.UpdateRescue - Rescue Removed: ${rescue.id} : `,rescue);if(rescue.id&&this.SelectedRescue&&rescue.id===this.SelectedRescue.id){this.SetSelectedRescue(null)}delete this.CachedRescues[sid];return}window.console.debug(`fr.client.UpdateRescue - Rescue Updated: ${rescue.id} : `,rescue);this.replaceHtml(`tr.rescue[data-rescue-sid="${sid}"]`,this.GetRescueTableRow(rescue));this.CachedRescues[sid]=rescue;if(rescue.id&&this.SelectedRescue&&rescue.id===this.SelectedRescue.id){window.console.debug(`fr.client.UpdateRescue - Rescue DetailView Updating: ${rescue.id} : `,rescue);this.SelectedRescue=rescue;this.UpdateRescueDetail()}},GetRescueTableRow:function(rescue){if(!rescue){return}let shortid=rescue.id.split("-")[0];let rats=rescue.relationships.rats.data===undefined?rescue.relationships.rats:{};let ratHtml=[];for(let ratID in rats){if(rats.hasOwnProperty(ratID)){ratHtml.push(`<span class="rat" data-rat-uuid="${ratID}">${rescue.relationships.rats[ratID].attributes.name}</span>`)}}for(let rat of rescue.attributes.unidentifiedRats){ratHtml.push(`<span class="rat-unidentified">${rat}</span> <span class="badge badge-yellow">unidentified</span>`)}let language=rescue.attributes.data.langID?fr.const.language[rescue.attributes.data.langID]?fr.const.language[rescue.attributes.data.langID]:{short:rescue.attributes.data.langID,long:rescue.attributes.data.langID}:fr.const.language.unknown;let platform=rescue.attributes.platform?fr.const.platform[rescue.attributes.platform]:fr.const.platform.unknown;let row=$(`<tr class="rescue" data-rescue-sid="${shortid}">`+`<td class="rescue-row-index">${typeof rescue.attributes.data.boardIndex==="number"?rescue.attributes.data.boardIndex:"?"}</td>`+`<td class="rescue-row-client" title="${rescue.attributes.data.IRCNick||""}">${rescue.attributes.client||"?"}</td>`+`<td class="rescue-row-language" title="${language.long}">${language.short}</td>`+`<td class="rescue-row-platform" title="${platform.long}">${platform.short}</td>`+`<td class="rescue-row-system btn-clipboard" data-clipboard-text="${rescue.attributes.system||"Unknown"}">${rescue.attributes.system||"Unknown"} <i class="fa fa-clipboard" title="Click to Copy!"></i></td>`+`<td class="rescue-row-rats">${ratHtml.join(", ")}</td>`+`<td class="rescue-row-detail"><button type="button" class="btn btn-detail" data-rescue-sid="${shortid}"><span class="fa fa-info" aria-hidden="true"></span></button></td>`+"</tr>");if(rescue.attributes.codeRed){row.addClass("rescue-codered")}else{row.removeClass("rescue-codered")}if(rescue.attributes.status==="inactive"){row.addClass("rescue-inactive")}else{row.removeClass("rescue-inactive")}row.attr("title",rescue.attributes.quotes!==null?rescue.attributes.quotes.map(quote=>`[${quote.createdAt}] "${quote.message}" - ${quote.author}`).join("\n"):"No known quotes....");return row},UpdateClocks:function(){let nowTime=new Date;$(".ed-clock").text(Util.getDateHumanReadable(nowTime));if(this.SelectedRescue!==null){$(".rdetail-timer").text(Util.getTimeSpanString(nowTime,Date.parse(this.SelectedRescue.attributes.createdAt))).prop("title","Last Updated: "+Util.getTimeSpanString(nowTime,Date.parse(this.SelectedRescue.attributes.updatedAt)))}setTimeout(()=>{this.UpdateClocks()},1e3-nowTime.getMilliseconds())},SetSelectedRescue:function(key,preventPush){if(key===null||this.SelectedRescue&&key.toString()===this.SelectedRescue.id.split("-")[0]){this.SelectedRescue=null;if(history.pushState&&!preventPush){window.history.pushState({a:null},document.title,window.location.pathname)}this.UpdateRescueDetail();return}if(!this.CachedRescues[key]){window.console.error(`fr.client.SetSelectedRescue - invalid key: ${key}`);return}window.console.debug(`fr.client.SetSelectedRescue - New SelectedRescue: ${this.CachedRescues[key].id}`);this.SelectedRescue=this.CachedRescues[key];if(history.pushState&&!preventPush){window.history.pushState({a:key},document.title,window.location.pathname+`?a=${encodeURIComponent(key)}`)}this.UpdateRescueDetail()},UpdateRescueDetail:function(){$("button.btn-detail.active").removeClass("active");if(!this.SelectedRescue){$("body").removeClass("rdetail-active");return}let rescue=this.SelectedRescue;let caseNo=typeof rescue.attributes.data.boardIndex==="number"?`#${rescue.attributes.data.boardIndex} - `:"";let title=rescue.attributes.title?rescue.attributes.title:rescue.attributes.client;let tags=(rescue.attributes.codeRed?' <span class="badge badge-red">Code Red</span>':"")+(rescue.attributes.status==="inactive"?' <span class="badge badge-yellow">Inactive</span>':"");let language=rescue.attributes.data.langID?fr.const.language[rescue.attributes.data.langID]?fr.const.language[rescue.attributes.data.langID]:{short:rescue.attributes.data.langID,long:rescue.attributes.data.langID}:fr.const.language.unknown;let platform=rescue.attributes.platform?fr.const.platform[rescue.attributes.platform]:fr.const.platform.unknown;let detailContent=`<div class="rdetail-header"><div class="rdetail-title">${caseNo+title+tags}</div><div class="rdetail-timer">00:00:00</div></div>`+'<table class="rdetail-body table table-rescue"><thead><td width="90px"></td><td></td></thead><tbody>'+(rescue.attributes.data.IRCNick?'<tr class="rdetail-info"><td class="rdetail-info-title">IRC Nick</td>'+`<td class="rdetail-info-value">${rescue.attributes.data.IRCNick}</td></tr>`:"")+(rescue.attributes.system?'<tr class="rdetail-info"><td class="rdetail-info-title">System</td>'+`<td class="rdetail-info-value">${rescue.attributes.system}`+`<span class="float-right system-apidata" data-system-name="${rescue.attributes.system.toUpperCase()}"><i>Retrieving info...</i></span></td></tr>`:"")+(rescue.attributes.platform?'<tr class="rdetail-info"><td class="rdetail-info-title">Platform</td>'+`<td class="rdetail-info-value">${platform.long}</td></tr>`:"")+(rescue.attributes.data.langID?'<tr class="rdetail-info"><td class="rdetail-info-title">Language</td>'+`<td class="rdetail-info-value">${language.long} (${language.short})</td></tr>`:"")+'<tr class="rdetail-info"><td class="rdetail-info-title">UUID</td>'+`<td class="rdetail-info-value">${rescue.id}</td></tr>`+'<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>';let rats=rescue.relationships.rats.data===undefined?rescue.relationships.rats:{};let ratHtml=[];for(let ratID in rats){if(!rats.hasOwnProperty(ratID)){continue}ratHtml.push(`<span class="rat" data-rat-uuid="${ratID}">${rats[ratID].attributes.name} ${rats[ratID].attributes.platform!==rescue.attributes.platform?'<span class="badge badge-yellow">Wrong Platform!</span>':""}</span>`)}for(let rat of rescue.attributes.unidentifiedRats){ratHtml.push(`<span class="rat-unidentified">${rat}</span> <span class="badge badge-yellow">unidentified</span>`)}if(ratHtml.length>0){detailContent+='<tr class="rdetail-info"><td class="rdetail-info-title">Rats</td><td class="rdetail-info-value tbl-border-box">'+ratHtml[0]+"</td></tr>";if(ratHtml.length>1){for(let rh=1;rh<ratHtml.length;rh++){detailContent+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${ratHtml[rh]}</td></tr>`}}detailContent+='<tr class="rdetail-info-seperator"><td class="tbl-border-none"></td><td></td></tr>'}if(rescue.attributes.quotes&&rescue.attributes.quotes.length>0){let quotes=[];for(let quote of rescue.attributes.quotes){quotes.push(`<span class="rdetail-quote-time">[${Util.getDateHumanReadable(new Date(quote.createdAt))}]</span> "<span class="rdetail-quote-message">${quote.message}</span>" - ${quote.lastAuthor}`)}detailContent+=`<tr class="rdetail-info"><td class="rdetail-info-title">Quotes</td><td class="rdetail-info-value tbl-border-box">${quotes[0]}</td></tr>`;if(quotes.length>1){for(let q=1;q<quotes.length;q++){detailContent+=`<tr class="rdetail-info"><td class="rdetail-info-empty"></td><td class="rdetail-info-value tbl-border-box">${quotes[q]}</td></tr>`}}}detailContent+="</tbody></table>";window.console.debug(`fr.client.UpdateRescueDetail - Rescue DetailView Updated: ${rescue.id} :`,rescue);this.setHtml("#rescueDetailContent",detailContent);$(`button.btn.btn-detail[data-rescue-sid="${rescue.id.split("-")[0]}"]`).addClass("active");$("body").addClass("rdetail-active");if(!rescue.attributes.system){return}window.console.debug("fr.client.UpdateRescueDetail - Checking sysapi for additional system info.");this.getSystemHtml(rescue).then(html=>{this.setHtml(`span[data-system-name="${rescue.attributes.system.toUpperCase()}"]`,html)}).catch(()=>{this.setHtml(`span[data-system-name="${rescue.attributes.system.toUpperCase()}"]`,'<a target="_blank" href="https://www.eddb.io/"><span class="badge badge-red" title="Go to EDDB.io" >NOT IN EDDB</span></a>')})},getSystemHtml:function(rescue){if(!rescue){return Promise.reject("")}return this.sysApi.get(rescue.attributes.system).then(data=>{window.console.debug("this.UpdateRescueDetail - Additional info found! Adding system-related warnings and eddb link.");let sysInfo=data;let sysName=sysInfo.attributes.name.toUpperCase();let sysInfoHtml="";if(sysInfo.attributes.needs_permit&&sysInfo.attributes.needs_permit===1){sysInfoHtml+='<span class="badge badge-yellow" title="This system requires a permit!">PERMIT</span> '}if(sysInfo.attributes.is_populated&&sysInfo.attributes.is_populated===1){sysInfoHtml+=' <span class="badge badge-yellow" title="This system is populated, check for stations!">POPULATED</span> '}if(sysInfo.bodies&&sysInfo.bodies.length>0){let mainStar=sysInfo.bodies.find(function(body){return body.attributes.is_main_star});if(mainStar&&fr.const.scoopables.includes(mainStar.attributes.spectral_class)){sysInfoHtml+=' <span class="badge badge-yellow" title="This system\'s main star is scoopable!">SCOOPABLE</span> '}else if(sysInfo.bodies.length>1&&sysInfo.bodies.filter(function(body){return fr.const.scoopables.includes(body.attributes.spectral_class)}).length>0){sysInfoHtml+=' <span class="badge badge-yellow" title="This system contains a scoopable star!">SCOOPABLE [SECONDARY]</span> '}}if(sysInfo.id){sysInfoHtml+=`<a target="_blank" href="https://www.eddb.io/system/${sysInfo.id}"><span class="badge badge-green" title="View on EDDB.io" >EDDB</span></a>`}return Promise.resolve(sysInfoHtml)})},setHtml:function(target,html){$(target).animate({opacity:.2},100).html(html).animate({opacity:1},500)},replaceHtml:function(target,html){$(target).replaceWith(html);$(target).animate({opacity:.2},100).animate({opacity:1},500)},appendHtml:function(target,html){$(target).append(html)}};(function(exports){"use strict";function RatSocket(uri){if(typeof uri!=="string"){throw new TypeError("URI must be a string")}this.WSSUri=uri;this.socket=null;this.currentToken=null;this.reconnected=false;this.isAuthenticated=false;this.openRequests={};this.listeners={}}let rsp=RatSocket.prototype;function alias(funcName){return function aliasWrapper(){return this[funcName].apply(this,arguments)}}function makeID(length=48){let chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";let text=[];let i=0;for(i=0;i<length;i+=1){text.push(chars.charAt(Math.floor(Math.random()*chars.length)))}return text.join("")}rsp.createSocket=function createSocket(token){if(typeof token!=="string"){throw TypeError("Invalid token string")}this.currentToken=token;return new Promise((resolve,reject)=>{let rejectTimeout=window.setTimeout(()=>{window.console.error(`RatSocket - Connection failed.`);reject({context:this,data:{errors:[{code:408,detail:"Server produced no response.",status:"Request Timeout",title:"Request Timeout"}],meta:{}}})},6e4);this.once("ratsocket:connect",(context,data)=>{window.clearTimeout(rejectTimeout);window.console.debug(`RatSocket - Connection successful!`);resolve({context:context,data:data})}).once("ratsocket:error",(context,data)=>{window.clearTimeout(rejectTimeout);reject({context:context,data:{errors:[{code:500,detail:data,status:"Error.",title:"Error."}],meta:{}}})});this.socket=new WebSocket(`${this.WSSUri}?bearer=${token}`);this.socket.onopen=(data=>{this._onSocketOpen(data)});this.socket.onclose=(data=>{this._onSocketClose(data)});this.socket.onerror=(data=>{this._onSocketError(data)});this.socket.onmessage=(data=>{this._onSocketMessage(data)});window.console.debug("RatSocket - Socket opened, awaiting connection confirmation...")})};rsp.connect=alias("createSocket");rsp._reconnect=function reconnect(){if(this.currentToken!==null){window.console.debug("RatSocket - Attempting reconnect with last known bearer token.... ",this);this.createSocket(this.currentToken)}else{window.console.debug("RatSocket - A reconnect was attempted, but no token was found!")}};rsp._onSocketOpen=function onSocketOpen(data){if(this.reconnected){window.console.debug("RatSocket - Socket reconnected! ",data);this._emitEvent("ratsocket:reconnect",data);this.reconnected=false;return}this._emitEvent("ratsocket:connect",data);window.console.debug("RatSocket - Socket Connected!",data)};rsp._onSocketClose=function onSocketClose(dc){if(dc.wasClean===false){window.console.debug("RatSocket - Disconnected from API! Attempting to reconnect... ",dc);this._emitEvent("ratsocket:disconnect",dc);this.initComp=false;setTimeout(()=>{window.console.debug(this);this._reconnect()},5e3);this.reconnected=true}};rsp._onSocketError=function onSocketError(data){window.console.error("RatSocket - Socket Error: ",data);this._emitEvent("ratsocket:error",data)};rsp._onSocketMessage=function onSocketMessage(data){window.console.debug("RatSocket - Received message: ",data);let _data=JSON.parse(data.data);if(typeof _data.meta.reqID==="string"&&this.openRequests.hasOwnProperty(_data.meta.reqID)){window.console.debug(`RatSocket - Detected request response. closing request: ${_data.meta.reqID}`);this.openRequests[_data.meta.reqID](_data);delete this.openRequests[_data.meta.reqID];return}else if(_data.meta.event){this._emitEvent(_data.meta.event,_data)}else{window.console.error("RatSocket - Received an unknown message from the attached websocket: ",data)}};rsp.send=function send(data){if(this.socket.readyState!==1){if(this.socket.readyState>1){this._reconnect()}setTimeout(()=>{this.send(data)});return this}if(!Util.isValidProperty(data,"action","array")||data.action.length>2||data.action.length<1){throw TypeError("Action array must be defined.")}if(!Util.isValidProperty(data,"data","object")){data.data={}}if(!Util.isValidProperty(data,"meta","object")){data.meta={}}window.console.debug("RatSocket - Sending message: ",data);this.socket.send(JSON.stringify(data));return this};rsp.sendRequest=function sendRequest(data){if(!Util.isValidProperty(data,"meta","object")){data.meta={}}let requestID=makeID(48);data.meta.reqID=requestID;return new Promise((resolve,reject)=>{this.send(data);let timeout=window.setTimeout(()=>{reject({context:this,data:{errors:[{code:408,detail:"Server produced no response.",status:"Request Timeout",title:"Request Timeout"}],meta:data.meta}})},6e4);this.openRequests[requestID]=(data=>{window.clearTimeout(timeout);if(data.errors){reject({context:this,data:data})}resolve({context:this,data:data})})})};rsp.request=alias("sendRequest");rsp.subscribe=function subscribe(streamName){return this.request({action:["stream","subscribe"],id:streamName,data:{},meta:{}})};rsp.addListener=function addListener(evt,func){if(typeof evt!=="string"||typeof func===null){throw new TypeError("Invalid argument(s)")}if(!this.listeners.hasOwnProperty(evt)){this.listeners[evt]=[]}this.listeners[evt].push(typeof func==="object"?func:{func:func,once:false});return this};rsp.on=alias("addListener");rsp.addListenerOnce=function addListenerOnce(evt,func){return this.addListener(evt,{func:func,once:true})};rsp.once=alias("addListenerOnce");rsp.removeListener=function removeListener(evt,func){if(typeof evt!=="string"||typeof func!=="function"){throw new TypeError("Invalid argument(s)")}if(!this.listeners.hasOwnProperty(evt)){return}let listenerIndex=this.listeners[evt].findIndex(x=>x.func===func);if(listenerIndex<0){return}this.listeners[evt].splice(listenerIndex,1);return this};rsp.off=alias("removeListener");rsp._emitEvent=function emitEvent(evt,args){if(typeof evt!=="string"){throw new TypeError("Event must be string")}if(!this.listeners.hasOwnProperty(evt)){window.console.debug(`RatSocket - Event: "${evt}" has no listener. Returning...`);return}let evtargs=[this];if(Array.isArray(args)){evtargs.concat(args)}else{evtargs.push(args)}let evtListeners=this.listeners[evt];window.console.debug(`RatSocket - Executing listener functions for: ${evt} with args:`,args);for(let i=0;i<evtListeners.length;i++){let listener=evtListeners[i];let res=listener.func.apply(this,evtargs);if(listener.once===true||res===true){this.removeListener(evt,listener.func)}}return this};exports.RatSocket=RatSocket})(this||{});(function(exports){"use strict";function StarSystemAPI(){}let sap=StarSystemAPI.prototype;function alias(funcName){return function aliasWrapper(){return this[funcName].apply(this,arguments)}}sap._apiLookupCall=function apiLookupCall(system){return new Promise((resolve,reject)=>{system=system.toUpperCase();$.ajax({dataType:"json",url:`https://system.api.fuelrats.com/systems?filter[name:eq]=${encodeURIComponent(system)}&include=bodies`,success:function(response){if(response.meta.results.returned<1){window.console.debug(`StarSystems - No system info found for: ${system}. Sysinfo search failed. Calling failCallback.`);sessionStorage.setItem(`${fr.config.AppNamespace}.system.${system.toUpperCase()}`,null);reject("System not found.");return}let sysData=response.data[0];let sysName=sysData.attributes.name;if(response.included&&response.included[0]){sysData.bodies=response.included.filter(function(body){return body.attributes.group_name==="Star"});for(let body in sysData.bodies){if(sysData.bodies.hasOwnProperty(body)){delete sysData.bodies[body].relationships;delete sysData.bodies[body].type;delete sysData.bodies[body].links}}}delete sysData.relationships;delete sysData.type;delete sysData.links;if(!sessionStorage.getItem(`${fr.config.AppNamespace}.system.${sysName}`)){sessionStorage.setItem(`${fr.config.AppNamespace}.system.${sysName}`,JSON.stringify(sysData))}window.console.debug("StarSystems - System information found: ",sysData);resolve(sysData)}})})};sap.getSysInfo=function getSystemInfo(system){system=system.toUpperCase();if(sessionStorage.getItem(`${fr.config.AppNamespace}.system.${system}`)){let sysData=JSON.parse(sessionStorage.getItem(`${fr.config.AppNamespace}.system.${system}`));window.console.debug("StarSystems - Cached System Info Requested: ",sysData);if(sysData===null){return Promise.reject("System not found.")}return Promise.resolve(sysData)}else{window.console.debug(`StarSystems - Retrieving System Info: ${system}`);return this._apiLookupCall(system)}};sap.get=alias("getSysInfo");sap.deleteCachedInfo=function DeleteCachedInfo(system){let sysName=system.toUpperCase();if(sessionStorage.getItem(`${fr.config.AppNamespace}.system.${sysName}`)){sessionStorage.removeItem(`${fr.config.AppNamespace}.system.${sysName}`)}};sap.delete=alias("deleteCachedInfo");exports.StarSystemAPI=StarSystemAPI})(this||{});fr.user={ApiData:null,Settings:null,AuthHeader:null,emptyobject:{},isAuthenticated:function(){return this.ApiData!==null&&this.AuthHeader!==null},isAdministrator:function(){return Object.keys(this.ApiData.relationships.groups).filter(obj=>this.ApiData.relationships.groups[obj].isAdministrator).length>0},hasPermission:function(){return this.isAuthenticated()&&(this.isAdministrator()||this.ApiData.relationships.groups.hasOwnProperty("rat"))},init:function(){let authHeader=Util.GetCookie(`${fr.config.AppNamespace}.token`),tokenMatch=document.location.hash.match(/access_token=([\w-]+)/),token=!!tokenMatch&&tokenMatch[1];window.console.debug("fr.user.init - User module loaded, Starting authentication process.");if(token){this.AuthHeader=token;if(Util.CanSetCookies()){Util.SetCookie(`${fr.config.AppNamespace}.token`,this.AuthHeader,365*24*60*60*1e3)}if(window.history.replaceState){window.history.replaceState({},document.title,window.location.pathname+window.location.search)}}else if(authHeader){this.AuthHeader=authHeader.replace("Bearer ","");if(Util.CanSetCookies()){Util.SetCookie(`${fr.config.AppNamespace}.token`,this.AuthHeader,365*24*60*60*1e3)}}else{this.displayLogin();return}window.console.debug("fr.user.init - Auth token gathered, ensuring authentication and getting user data.");if(sessionStorage.getItem(`${fr.config.AppNamespace}.user.ApiData`)){this.ApiData=JSON.parse(sessionStorage.getItem(`${fr.config.AppNamespace}.user.ApiData`));window.console.debug(this.ApiData);this.handleLoginInit()}else{this.getApiData(this.AuthHeader).then(data=>{this.ApiData=data;sessionStorage.setItem(`${fr.config.AppNamespace}.user.ApiData`,JSON.stringify(this.ApiData));this.handleLoginInit()}).catch(error=>{this.handleApiDataFailure(error)})}},logoutUser:function(){Util.DelCookie(`${fr.config.AppNamespace}.token`);window.location.reload()},handleLoginInit:function(){if(!this.hasPermission()){$("body").removeClass("loading").addClass("shutter-force user-nopermission");return}$("body").on("click","button.logout",()=>{this.logoutUser()});$("#userMenu").attr("data-displaystate","menu");$("#userMenu .user-icon").on("error",event=>{$(event.currentTarget).attr("src",`//api.adorable.io/avatars/${this.ApiData.id}`)}).attr("src",`img/prof/${this.ApiData.id}.jpg`);$("#userMenu .user-options .rat-name").text(`CMDR ${this.getUserDisplayName()}`);window.console.log("%cWelcome CMDR "+this.getUserDisplayName()+". All is well here. Fly safe!","color: lightgreen; font-weight: bold; font-size: 1.25em;");fr.client.init()},getUserDisplayName:function(){return this.ApiData.attributes.displayRatId?this.ApiData.relationships.rats[this.ApiData.attributes.displayRatId].attributes.name:this.ApiData.relationships.rats[Object.keys(this.ApiData.relationships.rats)[0]].attributes.name},handleApiDataFailure:function(error){window.console.debug("fr.user.handleApiDataFailure - Api retrieval failure - Displaying login - Error Info: ",error);this.displayLogin()},displayLogin:function(){window.console.debug("fr.user.displayLogin - Displaying login screen.");window.history.replaceState("",document.title,window.location.pathname);$("button.login").on("click",()=>{window.location.href=encodeURI(`${fr.config.ApiURI}oauth2/authorize?response_type=token&scope=rescue.read rescue.write rescue.delete&client_id=${fr.config.ClientID}&redirect_uri=${window.location}`)});$("body").removeClass("loading").addClass("shutter-force user-unauthenticated");$("#userMenu").attr("data-displaystate","login")},getApiData:function(token){return new Promise((resolve,reject)=>{$.ajax({url:fr.config.ApiURI+"profile",beforeSend:request=>{request.setRequestHeader("Authorization",`Bearer ${token}`);request.setRequestHeader("Accept","application/json")},success:response=>{if(response&&response.data){window.console.debug("fr.user.getApiData - Retrieved authenticated user information: ",response);resolve(Util.mapRelationships(response).data)}else{window.console.debug("fr.user.getApiData - Invalid reponse from profile request.");reject({request:null,status:"error",error:"Invalid Response"})}},error:(request,status,error)=>{reject({request:request,status:status,error:error})}})})}};