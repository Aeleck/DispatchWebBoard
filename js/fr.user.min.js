fr.user={ApiData:null,Settings:null,AuthHeader:null,emptyobject:{},isAuthenticated:function(){return null!==this.ApiData&&null!==this.AuthHeader},isAdministrator:function(){return Object.keys(this.ApiData.relationships.groups).filter(t=>this.ApiData.relationships.groups[t].isAdministrator).length>0},hasPermission:function(){return this.isAuthenticated()&&(this.isAdministrator()||this.ApiData.relationships.groups.hasOwnProperty("rat"))},init:function(){let t=Util.GetCookie(`${fr.config.AppNamespace}.token`),e=document.location.hash.match(/access_token=([\w-]+)/),i=!!e&&e[1];if(window.console.debug("fr.user.init - User module loaded, Starting authentication process."),i)this.AuthHeader=i,Util.CanSetCookies()&&Util.SetCookie(`${fr.config.AppNamespace}.token`,this.AuthHeader,31536e6),window.history.replaceState&&window.history.replaceState({},document.title,window.location.pathname+window.location.search);else{if(!t)return void this.displayLogin();this.AuthHeader=t.replace("Bearer ",""),Util.CanSetCookies()&&Util.SetCookie(`${fr.config.AppNamespace}.token`,this.AuthHeader,31536e6)}window.console.debug("fr.user.init - Auth token gathered, ensuring authentication and getting user data."),sessionStorage.getItem(`${fr.config.AppNamespace}.user.ApiData`)?(this.ApiData=JSON.parse(sessionStorage.getItem(`${fr.config.AppNamespace}.user.ApiData`)),window.console.debug(this.ApiData),this.handleLoginInit()):this.getApiData(this.AuthHeader).then(t=>{this.ApiData=t;sessionStorage.setItem(`${fr.config.AppNamespace}.user.ApiData`,JSON.stringify(this.ApiData));this.handleLoginInit()}).catch(t=>{this.handleApiDataFailure(t)})},logoutUser:function(){Util.DelCookie(`${fr.config.AppNamespace}.token`),window.location.reload()},handleLoginInit:function(){this.hasPermission()?($("body").on("click","button.logout",()=>{this.logoutUser()}),$("#userMenu").attr("data-displaystate","menu"),$("#userMenu .user-icon").on("error",t=>{$(t.currentTarget).attr("src",`//api.adorable.io/avatars/${this.ApiData.id}`)}).attr("src",`img/prof/${this.ApiData.id}.jpg`),$("#userMenu .user-options .rat-name").text(`CMDR ${this.getUserDisplayName()}`),window.console.log("%cWelcome CMDR "+this.getUserDisplayName()+". All is well here. Fly safe!","color: lightgreen; font-weight: bold; font-size: 1.25em;"),fr.client.init()):$("body").removeClass("loading").addClass("shutter-force user-nopermission")},getUserDisplayName:function(){return this.ApiData.attributes.displayRatId?this.ApiData.relationships.rats[this.ApiData.attributes.displayRatId].attributes.name:this.ApiData.relationships.rats[Object.keys(this.ApiData.relationships.rats)[0]].attributes.name},handleApiDataFailure:function(t){window.console.debug("fr.user.handleApiDataFailure - Api retrieval failure - Displaying login - Error Info: ",t),this.displayLogin()},displayLogin:function(){window.console.debug("fr.user.displayLogin - Displaying login screen."),window.history.replaceState("",document.title,window.location.pathname),$("button.login").on("click",()=>{window.location.href=encodeURI(`${fr.config.ApiURI}oauth2/authorize?response_type=token&scope=rescue.read rescue.write rescue.delete&client_id=${fr.config.ClientID}&redirect_uri=${window.location}`)}),$("body").removeClass("loading").addClass("shutter-force user-unauthenticated"),$("#userMenu").attr("data-displaystate","login")},getApiData:function(t){return new Promise((e,i)=>{$.ajax({url:fr.config.ApiURI+"profile",beforeSend:e=>{e.setRequestHeader("Authorization",`Bearer ${t}`);e.setRequestHeader("Accept","application/json")},success:t=>{t&&t.data?(window.console.debug("fr.user.getApiData - Retrieved authenticated user information: ",t),e(Util.mapRelationships(t).data)):(window.console.debug("fr.user.getApiData - Invalid reponse from profile request."),i({request:null,status:"error",error:"Invalid Response"}))},error:(t,e,a)=>{i({request:t,status:e,error:a})}})})}};