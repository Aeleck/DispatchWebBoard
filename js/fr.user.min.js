fr.user=fr.config?{ApiData:null,Settings:null,AuthHeader:null,isAuthenticated:function(){return null!==this.ApiData&&null!==this.AuthHeader},hasPermission:function(){return this.isAuthenticated()&&("admin"===this.ApiData.group||this.ApiData.drilled)},init:function(){let e=GetCookie(fr.config.CookieBase+"token"),t=document.location.hash.match(/access_token=([\w-]+)/),i=!!t&&t[1];if(window.console.debug("fr.user.init - User module loaded, Starting authentication process."),i)this.AuthHeader=i,CanSetCookies()&&SetCookie(fr.config.CookieBase+"token",this.AuthHeader,31536e6),window.history.replaceState&&window.history.replaceState({},document.title,window.location.pathname+window.location.search);else{if(!e)return void this.DisplayLogin();this.AuthHeader=e.replace("Bearer ",""),CanSetCookies()&&SetCookie(fr.config.CookieBase+"token",this.AuthHeader,31536e6)}window.console.debug("fr.user.init - Auth token gathered, ensuring authentication and getting user data."),sessionStorage.getItem("user.ApiData")?(this.ApiData=JSON.parse(sessionStorage.getItem("user.ApiData")),this.handleLoginInit()):this.getApiData(this.AuthHeader).then(e=>{sessionStorage.setItem("user.ApiData",JSON.stringify(e));this.ApiData=e;this.handleLoginInit()}).catch(e=>{this.handleApiDataFailure(e)})},logoutUser:function(){DelCookie(fr.config.CookieBase+"token"),window.location.reload()},handleLoginInit:function(){this.hasPermission()?($("body").on("click","button.logout",()=>{this.logoutUser()}),window.console.log("%cWelcome CMDR "+this.ApiData.rats[0].CMDRname.toUpperCase()+". All is well here. Fly safe!","color: lightgreen; font-weight: bold; font-size: 1.25em;"),fr.ws.initConnection(),fr.client.init()):$("body").removeClass("loading").addClass("shutter-force user-nopermission")},handleApiDataFailure:function(e){debug&&window.console.log("Api retrieval failure - Displaying login - Error Info: ",e),this.DisplayLogin()},DisplayLogin:function(){window.history.replaceState("",document.title,window.location.pathname),$("button.login").on("click",()=>{window.location.href=fr.config.ApiURI+"oauth2/authorize?response_type=token&client_id="+fr.config.ClientID+"&redirect_uri="+window.location}),$("body").removeClass("loading").addClass("shutter-force user-unauthenticated")},getApiData:function(e){return new Promise((t,i)=>{$.ajax({url:fr.config.ApiURI+"profile",beforeSend:t=>{t.setRequestHeader("Authorization","Bearer "+e);t.setRequestHeader("Accept","application/json")},success:e=>{e&&e.data&&(debug&&window.console.log("fr.user.getApiData - Retrieved authenticated user information: ",e),t(e.data))},error:(e,t,o)=>{i({request:e,status:t,error:o})}})})}}:null;